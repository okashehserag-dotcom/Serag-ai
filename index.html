<!doctype html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Serag | سراج</title>

  <!-- Fonts (Arabic + English). If offline, system fallbacks will be used. -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --panel2:#f7fafc;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --shadow: 0 12px 30px rgba(15,23,42,.08);

      --navy:#0b2a5b;
      --indigo:#1d4ed8;
      --indigo2:#2563eb;

      --good:#16a34a;
      --bad:#dc2626;
      --warn:#f59e0b;

      --radius:18px;
      --ring: 0 0 0 4px rgba(37,99,235,.12);
    }

    html[data-theme="dark"]{
      --bg:#0b1220;
      --panel:#0f172a;
      --panel2:#0b1220;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#1f2a44;
      --shadow: 0 14px 32px rgba(0,0,0,.35);

      --navy:#93c5fd;
      --indigo:#60a5fa;
      --indigo2:#3b82f6;

      --ring: 0 0 0 4px rgba(96,165,250,.16);
    }

    *{ box-sizing:border-box }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:"IBM Plex Sans Arabic", system-ui, -apple-system, Segoe UI, Tahoma, Arial, sans-serif;
    }
    a{ color:inherit; text-decoration:none }
    button, input, select, textarea{
      font-family:inherit;
    }

    /* Icons */
    .ico{ width:20px; height:20px; color:currentColor; flex:0 0 auto; }
    .ico.lg{ width:26px; height:26px; }

    /* Typography helpers */
    .en{
      direction:ltr;
      unicode-bidi: plaintext;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      letter-spacing:.1px;
    }
    .muted{
      color:var(--muted);
      font-weight:600;
      line-height:1.75;
      font-size:13px;
    }
    .h1{
      margin:0;
      font-weight:800;
      font-size:18px;
      color:var(--navy);
      display:flex;
      align-items:center;
      gap:10px;
    }
    html[data-theme="dark"] .h1{ color:var(--text); }

    /* Layout */
    .app{
      display:grid;
      grid-template-columns: 280px 1fr;
      min-height:100vh;
    }
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; padding-bottom:72px; }
    }

    /* Sidebar */
    .sidebar{
      position:sticky;
      top:0;
      height:100vh;
      padding:16px;
      border-left:1px solid var(--border);
      background:linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);
    }
    @media (max-width: 980px){
      .sidebar{ display:none; }
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px 10px;
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:var(--shadow);
      background:var(--panel);
    }
    .brandLeft{
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      width:42px; height:42px;
      border-radius:14px;
      display:grid; place-items:center;
      background:linear-gradient(135deg, var(--indigo), var(--indigo2));
      box-shadow: 0 16px 30px rgba(37,99,235,.22);
      color:#fff;
      font-weight:900;
      font-family: Inter, system-ui, sans-serif;
      letter-spacing:.2px;
    }
    .brandTitle{
      font-weight:900;
      line-height:1.15;
    }
    .brandSub{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      margin-top:2px;
    }
    .toggleBtn{
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      width:40px; height:40px;
      border-radius:14px;
      display:grid; place-items:center;
      cursor:pointer;
      transition:.15s;
    }
    .toggleBtn:hover{ box-shadow:var(--shadow); transform: translateY(-1px); }

    .nav{
      margin-top:12px;
      display:grid;
      gap:8px;
    }
    .navBtn{
      width:100%;
      border:1px solid var(--border);
      background:var(--panel);
      padding:10px 12px;
      border-radius:16px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      transition:.15s;
      box-shadow: 0 6px 16px rgba(15,23,42,.06);
      color:var(--text);
      font-weight:800;
    }
    .navBtn:hover{ transform: translateY(-1px); box-shadow:var(--shadow); }
    .navBtn.active{
      border-color: rgba(37,99,235,.35);
      box-shadow: var(--ring), var(--shadow);
    }
    .navLeft{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .navLabel{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .chip{
      font-size:12px;
      font-weight:900;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--navy);
      background:transparent;
    }
    html[data-theme="dark"] .chip{ color:var(--text); }

    /* Main */
    .main{
      padding:18px 18px 60px;
      max-width: 1150px;
      margin:0 auto;
      width:100%;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .topbarRight{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      font-weight:900;
      font-size:12px;
      color:var(--text);
      background:var(--panel);
    }

    /* Cards */
    .grid{
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }
    .card{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background:var(--panel);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .cardHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .hr{ height:1px; background:var(--border); margin:12px 0; }

    /* Buttons */
    .btn{
      border:0;
      cursor:pointer;
      border-radius:16px;
      padding:10px 12px;
      font-weight:900;
      background:linear-gradient(135deg, var(--indigo), var(--indigo2));
      color:#fff;
      box-shadow: 0 14px 26px rgba(37,99,235,.22);
      transition:.15s;
      display:inline-flex;
      align-items:center;
      gap:8px;
      justify-content:center;
    }
    .btn:hover{ transform: translateY(-1px); opacity:.97; }
    .btn.secondary{
      background:transparent;
      border:1px solid var(--border);
      color:var(--text);
      box-shadow:none;
    }
    .btn.secondary:hover{ box-shadow:var(--shadow); }
    .btn.danger{
      background:transparent;
      border:1px solid rgba(220,38,38,.35);
      color:var(--bad);
      box-shadow:none;
    }

    /* Inputs */
    label{
      display:block;
      font-size:12px;
      font-weight:900;
      color:var(--navy);
      margin:10px 0 6px;
    }
    html[data-theme="dark"] label{ color:var(--text); }
    input, select, textarea{
      width:100%;
      border:1px solid var(--border);
      background:var(--panel2);
      color:var(--text);
      border-radius:16px;
      padding:10px 12px;
      outline:none;
      font-weight:800;
    }
    input:focus, select:focus, textarea:focus{ box-shadow: var(--ring); border-color: rgba(37,99,235,.35); }
    textarea{ min-height:100px; resize:vertical; }

    /* Views + transitions */
    .view{ display:none; }
    .view.active{ display:block; animation: in .22s ease; }
    @keyframes in{
      from{ opacity:0; transform: translateY(8px); }
      to{ opacity:1; transform: translateY(0); }
    }

    /* Stepper */
    .stepper{ display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 0; }
    .stepDot{
      flex:1; min-width:90px; height:10px;
      background: rgba(148,163,184,.35);
      border-radius:999px;
      overflow:hidden;
    }
    .stepDot > span{
      display:block; height:100%; width:0%;
      background:linear-gradient(135deg, var(--indigo), var(--indigo2));
      transition: width .25s ease;
    }

    /* Progress bars */
    .bar{ height:12px; background: rgba(148,163,184,.35); border-radius:999px; overflow:hidden; }
    .bar > div{ height:100%; width:0%; background: linear-gradient(135deg, var(--good), #22c55e); transition: width .35s ease; }
    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 560px){
      .kpi{ grid-template-columns:1fr; }
    }
    .kpiCard{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:var(--panel2);
    }
    .kpiTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:900; color:var(--navy);
      margin-bottom:6px;
    }
    html[data-theme="dark"] .kpiTitle{ color:var(--text); }
    .kpiVal{ font-weight:900; font-size:20px; }
    .kpiSub{ font-size:12px; font-weight:700; color:var(--muted); line-height:1.55; }

    /* Options */
    .option{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:var(--panel2);
      cursor:pointer;
      transition:.15s;
      margin-top:10px;
      font-weight:900;
    }
    .option:hover{ transform: translateY(-1px); box-shadow:var(--shadow); }
    .option.correct{ border-color: rgba(34,197,94,.5); background: rgba(34,197,94,.08); }
    .option.wrong{ border-color: rgba(239,68,68,.5); background: rgba(239,68,68,.08); }

    /* Toast */
    .toast{
      position:fixed;
      right:14px;
      left:14px;
      bottom:14px;
      max-width:1150px;
      margin:0 auto;
      display:none;
      z-index:50;
    }
    .toast.show{ display:block; animation: in .2s ease; }
    .toastInner{
      border:1px solid var(--border);
      background:var(--panel);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .toastMsg{ font-weight:900; }

    /* Mobile bottom nav */
    .bottomNav{
      display:none;
      position:fixed;
      bottom:0;
      right:0; left:0;
      background: rgba(255,255,255,.85);
      border-top:1px solid var(--border);
      backdrop-filter: blur(10px);
      padding:10px 10px 12px;
      z-index:40;
    }
    html[data-theme="dark"] .bottomNav{ background: rgba(11,18,32,.85); }
    @media (max-width: 980px){
      .bottomNav{ display:block; }
    }
    .bottomRow{
      max-width:1150px;
      margin:0 auto;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:8px;
    }
    .bBtn{
      border:1px solid var(--border);
      background:var(--panel);
      border-radius:16px;
      padding:10px 8px;
      display:grid;
      place-items:center;
      gap:6px;
      cursor:pointer;
      transition:.15s;
      color:var(--text);
      font-weight:900;
      font-size:11px;
    }
    .bBtn.active{ box-shadow: var(--ring), var(--shadow); border-color: rgba(37,99,235,.35); }
    .bBtn:hover{ transform: translateY(-1px); box-shadow:var(--shadow); }

    /* Small table */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:16px;
      border:1px solid var(--border);
      background:var(--panel);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      font-size:13px;
      font-weight:800;
      text-align:right;
      vertical-align:top;
    }
    th{ color:var(--navy); background:var(--panel2); }
    html[data-theme="dark"] th{ color:var(--text); }
    tr:last-child td{ border-bottom:0; }

    /* Chips list */
    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .goalChip{
      border:1px solid var(--border);
      background:var(--panel2);
      color:var(--text);
      border-radius:999px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      transition:.15s;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .goalChip.active{
      border-color: rgba(37,99,235,.4);
      box-shadow: var(--ring);
      background: rgba(37,99,235,.10);
    }

    /* Tiny note */
    .note{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      line-height:1.7;
      margin-top:10px;
    }

    /* Audio player */
    .audioBox{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:var(--panel2);
      display:grid;
      gap:10px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-start;
    }
    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 780px){
      .split{ grid-template-columns:1fr; }
    }

    /* Small badge */
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--panel);
      font-weight:900;
      font-size:12px;
      color:var(--text);
    }

    /* Print-safe */
    @media print{
      .sidebar, .bottomNav, .toast{ display:none !important; }
      .main{ padding:0; }
      .card{ box-shadow:none; }
    }
  </style>
</head>

<body>
  <!-- SVG Icon Sprite (2D) -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <symbol id="i-sun" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        d="M12 3v2m0 14v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M3 12h2m14 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42M12 7a5 5 0 1 0 0 10a5 5 0 0 0 0-10z"/>
    </symbol>
    <symbol id="i-moon" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        d="M21 12.7A7.5 7.5 0 0 1 11.3 3A9 9 0 1 0 21 12.7z"/>
    </symbol>
    <symbol id="i-home" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1z"/>
    </symbol>
    <symbol id="i-roadmap" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        d="M7 21V3m10 18V3M7 7h10M7 12h10M7 17h10"/>
    </symbol>
    <symbol id="i-assess" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        d="M9 11l3 3L22 4M2 12a10 10 0 1 0 20 0"/>
    </symbol>
    <symbol id="i-mic" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        d="M12 14a3 3 0 0 0 3-3V7a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3zm7-3a7 7 0 0 1-14 0M12 21v-3"/>
    </symbol>
    <symbol id="i-book" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        d="M4 19a2 2 0 0 0 2 2h14V5a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2zm0 0a2 2 0 0 1 2-2h14"/>
    </symbol>
    <symbol id="i-chart" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        d="M4 19V5m0 14h16M8 16v-5m4 5v-8m4 8v-3"/>
    </symbol>
    <symbol id="i-gear" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        d="M12 15.5a3.5 3.5 0 1 0 0-7a3.5 3.5 0 0 0 0 7z"/>
      <path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        d="M19.4 15a7.9 7.9 0 0 0 .1-2l2-1.2-2-3.4-2.3.7a8 8 0 0 0-1.7-1l-.3-2.4H10l-.3 2.4a8 8 0 0 0-1.7 1L5.7 8.4l-2 3.4 2 1.2a7.9 7.9 0 0 0 .1 2l-2 1.2 2 3.4 2.3-.7a8 8 0 0 0 1.7 1l.3 2.4h4.8l.3-2.4a8 8 0 0 0 1.7-1l2.3.7 2-3.4z"/>
    </symbol>
    <symbol id="i-check" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        d="M20 6L9 17l-5-5"/>
    </symbol>
    <symbol id="i-warn" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        d="M12 9v4m0 4h.01M10.3 4.2 2.3 18a2 2 0 0 0 1.7 3h16a2 2 0 0 0 1.7-3l-8-13.8a2 2 0 0 0-3.4 0z"/>
    </symbol>
    <symbol id="i-volume" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        d="M11 5 6 9H3v6h3l5 4zM15.5 8.5a4 4 0 0 1 0 7M17.5 6.5a7 7 0 0 1 0 11"/>
    </symbol>
    <symbol id="i-upload" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        d="M12 3v12m0-12 4 4m-4-4-4 4M4 21h16"/>
    </symbol>
    <symbol id="i-download" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        d="M12 3v12m0 0 4-4m-4 4-4-4M4 21h16"/>
    </symbol>
  </svg>

  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <div class="brandLeft">
          <div class="logo">S</div>
          <div>
            <div class="brandTitle">Serag | سراج</div>
            <div class="brandSub en">Road to C2</div>
          </div>
        </div>
        <button class="toggleBtn" id="btnTheme" aria-label="Toggle theme" title="Theme">
          <svg class="ico"><use href="#i-moon"></use></svg>
        </button>
      </div>

      <div class="nav" id="sideNav">
        <button class="navBtn" data-route="home">
          <span class="navLeft">
            <svg class="ico"><use href="#i-home"></use></svg>
            <span class="navLabel">الرئيسية</span>
          </span>
          <span class="chip" id="chipStatus">غير مُعد</span>
        </button>

        <button class="navBtn" data-route="roadmap">
          <span class="navLeft">
            <svg class="ico"><use href="#i-roadmap"></use></svg>
            <span class="navLabel">خارطة C2</span>
          </span>
          <span class="chip" id="chipLevel">—</span>
        </button>

        <button class="navBtn" data-route="assessments">
          <span class="navLeft">
            <svg class="ico"><use href="#i-assess"></use></svg>
            <span class="navLabel">الاختبارات</span>
          </span>
          <span class="chip" id="chipNextTest">—</span>
        </button>

        <button class="navBtn" data-route="speaking">
          <span class="navLeft">
            <svg class="ico"><use href="#i-mic"></use></svg>
            <span class="navLabel">مختبر التحدث</span>
          </span>
          <span class="chip" id="chipFluency">—</span>
        </button>

        <button class="navBtn" data-route="study">
          <span class="navLeft">
            <svg class="ico"><use href="#i-book"></use></svg>
            <span class="navLabel">مواد اليوم</span>
          </span>
          <span class="chip" id="chipToday">0%</span>
        </button>

        <button class="navBtn" data-route="progress">
          <span class="navLeft">
            <svg class="ico"><use href="#i-chart"></use></svg>
            <span class="navLabel">التقدم</span>
          </span>
          <span class="chip" id="chipStreak">—</span>
        </button>

        <button class="navBtn" data-route="settings">
          <span class="navLeft">
            <svg class="ico"><use href="#i-gear"></use></svg>
            <span class="navLabel">الإعدادات</span>
          </span>
          <span class="chip">—</span>
        </button>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="topbar">
        <div class="h1" id="pageTitle">
          <svg class="ico lg"><use href="#i-home"></use></svg>
          <span>الرئيسية</span>
        </div>
        <div class="topbarRight">
          <span class="pill" id="pillMeta">—</span>
          <button class="btn secondary" id="btnThemeTop" style="display:none">
            <svg class="ico"><use href="#i-moon"></use></svg>
            <span>المظهر</span>
          </button>
        </div>
      </div>

      <!-- Onboarding -->
      <section class="view" id="view_onboarding">
        <div class="card">
          <div class="cardHeader">
            <div class="h1">
              <svg class="ico lg"><use href="#i-roadmap"></use></svg>
              <span>التهيئة</span>
            </div>
            <span class="badge" id="ob_stepLabel">1/4</span>
          </div>

          <div class="muted">حدد وقتك وأهدافك، ثم اختبار مستوى أكاديمي مختصر وبصمة تحدث. بعدها تُبنى الخطة تلقائيًا نحو <span class="en">C2</span>.</div>

          <div class="stepper">
            <div class="stepDot"><span id="ob_dot1"></span></div>
            <div class="stepDot"><span id="ob_dot2"></span></div>
            <div class="stepDot"><span id="ob_dot3"></span></div>
            <div class="stepDot"><span id="ob_dot4"></span></div>
          </div>

          <div class="hr"></div>

          <!-- Step 1 -->
          <div class="view active" id="ob_s1">
            <label>الاسم (اختياري)</label>
            <input id="inpName" placeholder="مثال: سراج" />

            <label>كم دقيقة يوميًا؟</label>
            <select id="inpMinutes">
              <option value="15">15</option>
              <option value="25">25</option>
              <option value="30" selected>30</option>
              <option value="45">45</option>
              <option value="60">60</option>
              <option value="90">90</option>
            </select>

            <label>التركيز الأساسي</label>
            <select id="inpFocus">
              <option value="balanced">متوازن</option>
              <option value="speaking">التحدث</option>
              <option value="writing">الكتابة الأكاديمية</option>
              <option value="reading">القراءة الأكاديمية</option>
              <option value="listening">الاستماع الأكاديمي</option>
            </select>

            <div class="row" style="margin-top:12px;">
              <button class="btn" id="ob_to2">
                <svg class="ico"><use href="#i-check"></use></svg>
                <span>التالي</span>
              </button>
            </div>
          </div>

          <!-- Step 2 -->
          <div class="view" id="ob_s2">
            <label>اختر أهدافك (يمكن أكثر من هدف)</label>
            <div class="chips" id="goalsBox"></div>

            <label>أي هدف أهم؟</label>
            <select id="inpPrimaryGoal"></select>

            <div class="note">سيتم تخصيص المهام والأمثلة الأكاديمية بناءً على أهدافك.</div>

            <div class="row" style="margin-top:12px;">
              <button class="btn secondary" id="ob_back1">رجوع</button>
              <button class="btn" id="ob_to3">بدء اختبار المستوى</button>
            </div>
          </div>

          <!-- Step 3 -->
          <div class="view" id="ob_s3">
            <div class="muted">اختبار مستوى أكاديمي مختصر (12 سؤال) لتقدير البداية. أسئلة أصلية بنمط أكاديمي مستلهم من نماذج عالمية.</div>

            <div class="card" style="box-shadow:none; margin-top:12px;">
              <div class="cardHeader">
                <div class="h1" style="font-size:15px">
                  <svg class="ico"><use href="#i-assess"></use></svg>
                  <span id="qTitle">—</span>
                </div>
                <span class="badge" id="qCount">1/12</span>
              </div>
              <div class="muted" id="qHint">—</div>
              <div class="hr"></div>
              <div id="qOptions"></div>

              <div class="row" style="margin-top:12px;">
                <button class="btn secondary" id="qPrev">السابق</button>
                <button class="btn" id="qNext">التالي</button>
              </div>
            </div>

            <div class="row" style="margin-top:12px;">
              <button class="btn secondary" id="ob_back2">رجوع</button>
            </div>
          </div>

          <!-- Step 4 -->
          <div class="view" id="ob_s4">
            <div class="cardHeader">
              <div class="h1">
                <svg class="ico lg"><use href="#i-mic"></use></svg>
                <span>بصمة التحدث</span>
              </div>
              <span class="badge" id="levelBadge">—</span>
            </div>

            <div class="muted" id="resultText"></div>

            <div class="hr"></div>

            <div class="split">
              <div class="card" style="box-shadow:none;">
                <div class="cardHeader">
                  <div class="h1" style="font-size:15px">
                    <svg class="ico"><use href="#i-mic"></use></svg>
                    <span>تسجيل (60 ثانية)</span>
                  </div>
                  <span class="badge en" id="spkTimer">00:00</span>
                </div>

                <div class="muted">تحدث عن موضوع أكاديمي بسيط. ركّز على الفكرة الرئيسية، سبب، مثال.</div>

                <div class="audioBox" style="margin-top:12px;">
                  <div class="muted"><span class="en" id="spkPrompt"></span></div>
                  <div class="row">
                    <button class="btn secondary" id="btnTTS">
                      <svg class="ico"><use href="#i-volume"></use></svg>
                      <span>استماع</span>
                    </button>
                    <button class="btn" id="btnRecStart">
                      <svg class="ico"><use href="#i-mic"></use></svg>
                      <span>بدء</span>
                    </button>
                    <button class="btn secondary" id="btnRecStop" disabled>
                      <svg class="ico"><use href="#i-check"></use></svg>
                      <span>إيقاف</span>
                    </button>
                  </div>
                  <audio id="recAudio" controls style="width:100%; display:none"></audio>
                  <div class="note" id="recNote"></div>
                </div>
              </div>

              <div class="card" style="box-shadow:none;">
                <div class="cardHeader">
                  <div class="h1" style="font-size:15px">
                    <svg class="ico"><use href="#i-roadmap"></use></svg>
                    <span>ملخص الخطة</span>
                  </div>
                  <span class="badge" id="planBadge">—</span>
                </div>

                <div class="kpi">
                  <div class="kpiCard">
                    <div class="kpiTitle"><span>المستوى</span><span class="badge en" id="kpiLevel">—</span></div>
                    <div class="kpiSub">تقدير البداية. يُحدّث دوريًا بالاختبارات.</div>
                  </div>
                  <div class="kpiCard">
                    <div class="kpiTitle"><span>مؤشر الطلاقة</span><span class="badge en" id="kpiFluency">—</span></div>
                    <div class="kpiSub">يتحسن من سجل التحدث والاختبارات.</div>
                  </div>
                </div>

                <div class="hr"></div>
                <div id="planBox"></div>

                <div class="row" style="margin-top:12px;">
                  <button class="btn secondary" id="ob_back3">رجوع</button>
                  <button class="btn" id="ob_finish">بدء الاستخدام</button>
                </div>
              </div>
            </div>

          </div>
        </div>
      </section>

      <!-- Home -->
      <section class="view" id="view_home">
        <div class="grid">
          <div class="card">
            <div class="cardHeader">
              <div class="h1">
                <svg class="ico lg"><use href="#i-home"></use></svg>
                <span>جلسة اليوم</span>
              </div>
              <span class="badge" id="todayMeta">—</span>
            </div>

            <div class="muted">تدفق يومي أكاديمي مختصر. لا تنتقل للخطوة التالية إلا بعد إنهاء الحالية.</div>
            <div class="hr"></div>

            <div id="todayFlow"></div>

            <div class="row" style="margin-top:12px;">
              <button class="btn secondary" id="todayBack">رجوع</button>
              <button class="btn" id="todayNext">التالي</button>
            </div>

            <div class="note" id="capNote"></div>
          </div>

          <aside class="card">
            <div class="cardHeader">
              <div class="h1" style="font-size:16px">
                <svg class="ico"><use href="#i-chart"></use></svg>
                <span>ملخص</span>
              </div>
              <span class="badge" id="profileBadge">—</span>
            </div>

            <div class="muted" id="profileBox"></div>
            <div class="hr"></div>

            <div class="cardHeader">
              <div class="h1" style="font-size:16px">
                <svg class="ico"><use href="#i-assess"></use></svg>
                <span>الاختبار القادم</span>
              </div>
              <span class="badge en" id="nextTestBadge">—</span>
            </div>
            <div class="muted" id="nextTestBox"></div>

            <div class="hr"></div>

            <div class="cardHeader">
              <div class="h1" style="font-size:16px">
                <svg class="ico"><use href="#i-check"></use></svg>
                <span>تقدم اليوم</span>
              </div>
              <span class="badge en" id="todayPct">0%</span>
            </div>
            <div class="bar"><div id="todayBar"></div></div>

            <div class="hr"></div>

            <div class="row">
              <button class="btn" id="goAssess">بدء اختبار</button>
              <button class="btn secondary" id="goSpeaking">تسجيل تحدث</button>
            </div>
          </aside>
        </div>
      </section>

      <!-- Roadmap -->
      <section class="view" id="view_roadmap">
        <div class="card">
          <div class="cardHeader">
            <div class="h1">
              <svg class="ico lg"><use href="#i-roadmap"></use></svg>
              <span>خارطة الوصول إلى <span class="en">C2</span></span>
            </div>
            <span class="badge" id="roadBadge">—</span>
          </div>

          <div class="muted">الخطة تُدار على مراحل. المدة تقديرية وتتغير حسب الالتزام ونتائج الاختبارات الدورية.</div>
          <div class="hr"></div>

          <div id="roadmapBox"></div>
        </div>
      </section>

      <!-- Assessments -->
      <section class="view" id="view_assessments">
        <div class="grid">
          <div class="card">
            <div class="cardHeader">
              <div class="h1">
                <svg class="ico lg"><use href="#i-assess"></use></svg>
                <span>الاختبارات الدورية</span>
              </div>
              <span class="badge" id="assessMeta">—</span>
            </div>

            <div class="muted">اختبارات أصلية بنمط أكاديمي (مستلهمة من أنواع مهام عالمية). تُستخدم لقياس التقدم وإعادة ضبط الخطة.</div>
            <div class="hr"></div>

            <div class="kpi">
              <div class="kpiCard">
                <div class="kpiTitle"><span>آخر اختبار</span><span class="badge en" id="lastTestBadge">—</span></div>
                <div class="kpiSub" id="lastTestSub">—</div>
              </div>
              <div class="kpiCard">
                <div class="kpiTitle"><span>الاختبار القادم</span><span class="badge en" id="dueTestBadge">—</span></div>
                <div class="kpiSub" id="dueTestSub">—</div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="row">
              <button class="btn" id="btnWeekly">Weekly Check</button>
              <button class="btn secondary" id="btnBiweekly">Biweekly Benchmark</button>
              <button class="btn secondary" id="btnMonthly">Monthly Progress Test</button>
            </div>

            <div class="hr"></div>

            <div id="testRunner" style="display:none"></div>
          </div>

          <aside class="card">
            <div class="cardHeader">
              <div class="h1" style="font-size:16px">
                <svg class="ico"><use href="#i-chart"></use></svg>
                <span>سجل النتائج</span>
              </div>
              <span class="badge" id="histCount">—</span>
            </div>

            <div id="historyBox"></div>
          </aside>
        </div>
      </section>

      <!-- Speaking -->
      <section class="view" id="view_speaking">
        <div class="grid">
          <div class="card">
            <div class="cardHeader">
              <div class="h1">
                <svg class="ico lg"><use href="#i-mic"></use></svg>
                <span>مختبر التحدث (أكاديمي)</span>
              </div>
              <span class="badge en" id="spkMeta">—</span>
            </div>

            <div class="muted">سجل محاولات التحدث. كل محاولة تُحدّث مؤشر الطلاقة وتغذي الخطة.</div>
            <div class="hr"></div>

            <div class="split">
              <div class="card" style="box-shadow:none;">
                <div class="cardHeader">
                  <div class="h1" style="font-size:15px">
                    <svg class="ico"><use href="#i-mic"></use></svg>
                    <span>Timed Talk</span>
                  </div>
                  <span class="badge en" id="labTimer">00:00</span>
                </div>

                <label>المدة</label>
                <select id="labDur">
                  <option value="60" selected>60</option>
                  <option value="90">90</option>
                  <option value="120">120</option>
                </select>

                <label>الموضوع</label>
                <select id="labTopic"></select>

                <div class="row" style="margin-top:10px;">
                  <button class="btn secondary" id="labTTS">
                    <svg class="ico"><use href="#i-volume"></use></svg>
                    <span>استماع للمهمة</span>
                  </button>
                  <button class="btn" id="labStart">
                    <svg class="ico"><use href="#i-mic"></use></svg>
                    <span>بدء تسجيل</span>
                  </button>
                  <button class="btn secondary" id="labStop" disabled>
                    <svg class="ico"><use href="#i-check"></use></svg>
                    <span>إيقاف</span>
                  </button>
                </div>

                <div class="audioBox" style="margin-top:12px;">
                  <audio id="labAudio" controls style="width:100%; display:none"></audio>
                  <div class="note" id="labNote"></div>
                </div>

                <div class="hr"></div>

                <label>تقييم ذاتي سريع (Rubric)</label>
                <div class="split">
                  <div>
                    <label class="muted" style="margin:0 0 6px">Fluency</label>
                    <select id="rFlu">
                      <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option>
                    </select>
                  </div>
                  <div>
                    <label class="muted" style="margin:0 0 6px">Coherence</label>
                    <select id="rCoh">
                      <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option>
                    </select>
                  </div>
                  <div>
                    <label class="muted" style="margin:0 0 6px">Pronunciation</label>
                    <select id="rPro">
                      <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option>
                    </select>
                  </div>
                  <div>
                    <label class="muted" style="margin:0 0 6px">Lexical</label>
                    <select id="rLex">
                      <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option>
                    </select>
                  </div>
                </div>

                <div class="row" style="margin-top:12px;">
                  <button class="btn" id="saveSpeakingAttempt">حفظ المحاولة</button>
                </div>
              </div>

              <div class="card" style="box-shadow:none;">
                <div class="cardHeader">
                  <div class="h1" style="font-size:15px">
                    <svg class="ico"><use href="#i-chart"></use></svg>
                    <span>الملخص</span>
                  </div>
                  <span class="badge en" id="fluencyBadge">—</span>
                </div>

                <div class="muted" id="speakingSummary"></div>

                <div class="hr"></div>

                <div class="cardHeader">
                  <div class="h1" style="font-size:15px">
                    <svg class="ico"><use href="#i-assess"></use></svg>
                    <span>آخر محاولات</span>
                  </div>
                  <span class="badge" id="attemptCount">—</span>
                </div>

                <div id="attemptsBox"></div>
              </div>
            </div>
          </div>

          <aside class="card">
            <div class="cardHeader">
              <div class="h1" style="font-size:16px">
                <svg class="ico"><use href="#i-roadmap"></use></svg>
                <span>مهمة اليوم</span>
              </div>
              <span class="badge en" id="todSpkDur">—</span>
            </div>
            <div class="muted" id="todaySpeakingTask"></div>
            <div class="hr"></div>
            <div class="row">
              <button class="btn secondary" id="refreshTopic">تحديث</button>
              <button class="btn" id="goStudyFromSpeaking">مواد اليوم</button>
            </div>
          </aside>
        </div>
      </section>

      <!-- Study -->
      <section class="view" id="view_study">
        <div class="grid">
          <div class="card">
            <div class="cardHeader">
              <div class="h1">
                <svg class="ico lg"><use href="#i-book"></use></svg>
                <span>مواد اليوم (أكاديمي)</span>
              </div>
              <span class="badge" id="studyMeta">—</span>
            </div>

            <div class="muted">نص أكاديمي قصير + مهمة فهم + تمرين Use of English + كتابة قصيرة.</div>
            <div class="hr"></div>

            <div id="studyBox"></div>

            <div class="row" style="margin-top:12px;">
              <button class="btn secondary" id="markStudyDone">وضع كمكتمل</button>
              <button class="btn" id="goPracticeAssess">بدء اختبار</button>
            </div>
          </div>

          <aside class="card">
            <div class="cardHeader">
              <div class="h1" style="font-size:16px">
                <svg class="ico"><use href="#i-check"></use></svg>
                <span>مؤشرات الخطة</span>
              </div>
              <span class="badge" id="planFocusBadge">—</span>
            </div>

            <div class="muted" id="planFocusBox"></div>

            <div class="hr"></div>

            <div class="cardHeader">
              <div class="h1" style="font-size:16px">
                <svg class="ico"><use href="#i-chart"></use></svg>
                <span>تقدم اليوم</span>
              </div>
              <span class="badge en" id="studyTodayPct">0%</span>
            </div>
            <div class="bar"><div id="studyTodayBar"></div></div>

            <div class="hr"></div>

            <div class="row">
              <button class="btn secondary" id="btnTTSStudy">
                <svg class="ico"><use href="#i-volume"></use></svg>
                <span>استماع للنص</span>
              </button>
              <button class="btn secondary" id="goSpeakingFromStudy">تسجيل تحدث</button>
            </div>
          </aside>
        </div>
      </section>

      <!-- Progress -->
      <section class="view" id="view_progress">
        <div class="grid">
          <div class="card">
            <div class="cardHeader">
              <div class="h1">
                <svg class="ico lg"><use href="#i-chart"></use></svg>
                <span>التقدم</span>
              </div>
              <span class="badge" id="progMeta">—</span>
            </div>

            <div class="muted">تتبع الالتزام، درجات الاختبارات، ومؤشر الطلاقة.</div>
            <div class="hr"></div>

            <div class="kpi">
              <div class="kpiCard">
                <div class="kpiTitle"><span>Streak</span><span class="badge en" id="streakBadge">—</span></div>
                <div class="kpiSub" id="streakSub">—</div>
              </div>
              <div class="kpiCard">
                <div class="kpiTitle"><span>Fluency Index</span><span class="badge en" id="fluBadge2">—</span></div>
                <div class="kpiSub" id="fluSub2">—</div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="cardHeader">
              <div class="h1" style="font-size:15px">
                <svg class="ico"><use href="#i-assess"></use></svg>
                <span>أحدث نتائج</span>
              </div>
              <span class="badge" id="recentResBadge">—</span>
            </div>

            <div id="recentResults"></div>

            <div class="hr"></div>

            <div class="row">
              <button class="btn" id="goRoadmap">خارطة C2</button>
              <button class="btn secondary" id="goAssess2">اختبار</button>
            </div>
          </div>

          <aside class="card">
            <div class="cardHeader">
              <div class="h1" style="font-size:16px">
                <svg class="ico"><use href="#i-book"></use></svg>
                <span>ملاحظات</span>
              </div>
              <span class="badge">—</span>
            </div>

            <label>ملاحظاتك</label>
            <textarea id="notesArea" placeholder="اكتب هنا..."></textarea>
            <div class="row" style="margin-top:10px;">
              <button class="btn secondary" id="saveNotes">حفظ</button>
            </div>

            <div class="hr"></div>

            <div class="cardHeader">
              <div class="h1" style="font-size:16px">
                <svg class="ico"><use href="#i-assess"></use></svg>
                <span>تفسير التقدير</span>
              </div>
              <span class="badge">—</span>
            </div>
            <div class="muted" id="estimateExplain"></div>
          </aside>
        </div>
      </section>

      <!-- Settings -->
      <section class="view" id="view_settings">
        <div class="grid">
          <div class="card">
            <div class="cardHeader">
              <div class="h1">
                <svg class="ico lg"><use href="#i-gear"></use></svg>
                <span>الإعدادات</span>
              </div>
              <span class="badge" id="setMeta">—</span>
            </div>

            <div class="muted">استيراد وتصدير البيانات، والتحقق من دعم الجهاز للتسجيل وميزة الاستماع.</div>
            <div class="hr"></div>

            <div class="split">
              <div class="card" style="box-shadow:none;">
                <div class="cardHeader">
                  <div class="h1" style="font-size:15px">
                    <svg class="ico"><use href="#i-download"></use></svg>
                    <span>تصدير</span>
                  </div>
                  <span class="badge">JSON</span>
                </div>
                <div class="row">
                  <button class="btn" id="btnExportFile">
                    <svg class="ico"><use href="#i-download"></use></svg>
                    <span>تنزيل الملف</span>
                  </button>
                  <button class="btn secondary" id="btnExportCopy">نسخ</button>
                </div>
                <div class="note" id="exportNote"></div>
              </div>

              <div class="card" style="box-shadow:none;">
                <div class="cardHeader">
                  <div class="h1" style="font-size:15px">
                    <svg class="ico"><use href="#i-upload"></use></svg>
                    <span>استيراد</span>
                  </div>
                  <span class="badge">JSON</span>
                </div>
                <input type="file" id="importFile" accept="application/json" />
                <div class="row" style="margin-top:10px;">
                  <button class="btn secondary" id="btnImport">استيراد</button>
                </div>
                <div class="note" id="importNote"></div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="cardHeader">
              <div class="h1" style="font-size:15px">
                <svg class="ico"><use href="#i-check"></use></svg>
                <span>قدرات الجهاز</span>
              </div>
              <span class="badge" id="capsBadge">—</span>
            </div>
            <div id="capsBox"></div>

            <div class="hr"></div>

            <div class="row">
              <button class="btn danger" id="btnReset">مسح البيانات</button>
            </div>
          </div>

          <aside class="card">
            <div class="cardHeader">
              <div class="h1" style="font-size:16px">
                <svg class="ico"><use href="#i-roadmap"></use></svg>
                <span>الملف الشخصي</span>
              </div>
              <span class="badge" id="profBadge2">—</span>
            </div>
            <div class="muted" id="profBox2"></div>

            <div class="hr"></div>

            <div class="cardHeader">
              <div class="h1" style="font-size:16px">
                <svg class="ico"><use href="#i-sun"></use></svg>
                <span>المظهر</span>
              </div>
              <span class="badge" id="themeBadge">—</span>
            </div>

            <div class="row">
              <button class="btn secondary" id="btnThemeSettings">
                <svg class="ico"><use href="#i-moon"></use></svg>
                <span>تبديل</span>
              </button>
            </div>
          </aside>
        </div>
      </section>

    </main>
  </div>

  <!-- Mobile bottom nav -->
  <nav class="bottomNav" aria-label="Navigation">
    <div class="bottomRow" id="bottomNav">
      <button class="bBtn" data-route="home">
        <svg class="ico"><use href="#i-home"></use></svg>
        <span>الرئيسية</span>
      </button>
      <button class="bBtn" data-route="roadmap">
        <svg class="ico"><use href="#i-roadmap"></use></svg>
        <span>خارطة</span>
      </button>
      <button class="bBtn" data-route="assessments">
        <svg class="ico"><use href="#i-assess"></use></svg>
        <span>اختبارات</span>
      </button>
      <button class="bBtn" data-route="speaking">
        <svg class="ico"><use href="#i-mic"></use></svg>
        <span>تحدث</span>
      </button>
      <button class="bBtn" data-route="study">
        <svg class="ico"><use href="#i-book"></use></svg>
        <span>مواد</span>
      </button>
    </div>
  </nav>

  <!-- Toast -->
  <div class="toast" id="toast" role="status" aria-live="polite">
    <div class="toastInner">
      <div class="toastMsg" id="toastMsg">—</div>
      <button class="btn secondary" id="toastOk">حسنًا</button>
    </div>
  </div>

<script>
/* =========================================================
   Serag | سراج (Single file)
   - Academic-first plan to C2
   - Multi-goals
   - Periodic assessments (original items, inspired task types)
   - Speaking recording + TTS
   - Dark mode
   - Import/Export
   ========================================================= */

const LS_KEY = "serag_index_v1";
const STATE_VERSION = 1;

/* -------------------------
   Utilities
-------------------------- */
const $ = (id)=> document.getElementById(id);
const clamp = (n,a,b)=> Math.max(a, Math.min(b,n));

function showToast(msg){
  $("toastMsg").textContent = msg;
  $("toast").classList.add("show");
}
$("toastOk").onclick = ()=> $("toast").classList.remove("show");

function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
}
function addDaysISO(iso, days){
  const d = new Date(iso);
  d.setDate(d.getDate()+days);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
}
function formatISO(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleDateString("ar", {year:"numeric", month:"2-digit", day:"2-digit"});
  }catch(e){ return iso; }
}
function safeJSONParse(raw){
  try{ return JSON.parse(raw); }catch(e){ return null; }
}
function speak(text){
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "en-US";
    u.rate = 0.95;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
    return true;
  }catch(e){
    return false;
  }
}

/* -------------------------
   State
-------------------------- */
const state = {
  version: STATE_VERSION,
  theme: "light",
  onboarding: { step: 1, done: false },
  profile: {
    name: "",
    minutes: 30,
    focus: "balanced",
    goals: ["academic"],       // multi-goals
    primaryGoal: "academic",
    level: null,              // A1/A2/B1/B2/C1/C2
    levelConf: 0.55,          // confidence 0..1
    fluencyIndex: 30,         // 0..100
  },
  placement: { index: 0, answers: Array(12).fill(null), score: 0 },
  progress: {
    points: 0,
    streak: 0,
    lastDay: null,
    todayPercent: 0,
    todayStep: 0,
    studyDoneToday: false
  },
  plan: {
    nextTestISO: null,
    lastTestISO: null,
    estimatedWeeksToNext: null,
    weights: { reading: 25, listening: 25, writing: 25, speaking: 25 }
  },
  assessments: {
    history: [] // {iso, type, skillScores:{R,L,W,S}, total, levelEstimate, fluDelta}
  },
  speaking: {
    attempts: [] // {iso, topic, dur, rubric:{flu,coh,pro,lex}, audioDataUrl, fluDelta}
  },
  notes: { text: "" },
  backups: { lastImportBackup: null }
};

/* -------------------------
   Goals
-------------------------- */
const GOALS = [
  {id:"academic", label:"أكاديمي"},
  {id:"travel", label:"سفر"},
  {id:"job", label:"عمل"},
  {id:"study", label:"دراسة"},
  {id:"exam", label:"اختبار"}
];

function ensureGoalsValid(){
  // must have at least one goal
  if(!Array.isArray(state.profile.goals) || state.profile.goals.length===0){
    state.profile.goals = ["academic"];
  }
  // primary goal must be in goals
  if(!state.profile.goals.includes(state.profile.primaryGoal)){
    state.profile.primaryGoal = state.profile.goals[0];
  }
}

/* -------------------------
   Academic content generators (original)
-------------------------- */
function rngSeeded(seedStr){
  // simple seeded rng (xorshift-ish)
  let h = 2166136261;
  for(let i=0;i<seedStr.length;i++){
    h ^= seedStr.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return function(){
    h += 0x6D2B79F5;
    let t = Math.imul(h ^ (h >>> 15), 1 | h);
    t ^= t + Math.imul(t ^ (t >>> 7), 61 | t);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

function pick(arr, r){
  return arr[Math.floor(r()*arr.length)];
}

function levelFromScore(score12){
  // placement score 0..12 => A1..C1
  if(score12 <= 2) return "A1";
  if(score12 <= 4) return "A2";
  if(score12 <= 6) return "B1";
  if(score12 <= 8) return "B2";
  return "C1";
}

function roadmapStageOrder(){ return ["A1","A2","B1","B2","C1","C2"]; }

function estimateWeeksToNext(level, minutes, paceFactor){
  // Heuristic; dynamic updates later by tests & consistency.
  // paceFactor ~ 0.7..1.3 (higher is faster)
  const base = {A1: 10, A2: 10, B1: 12, B2: 14, C1: 18, C2: 0};
  const mFactor = minutes >= 60 ? 0.75 : minutes >= 45 ? 0.85 : minutes >= 30 ? 1.0 : minutes >= 25 ? 1.15 : 1.3;
  const weeks = Math.round((base[level] || 12) * mFactor / paceFactor);
  return clamp(weeks, 4, 40);
}

function nextLevel(level){
  const order = roadmapStageOrder();
  const idx = order.indexOf(level);
  if(idx < 0) return "A1";
  if(idx >= order.length-1) return "C2";
  return order[idx+1];
}

function calcPlanWeights(){
  // Base academic mix
  let w = { reading: 28, listening: 22, writing: 26, speaking: 24 };

  // Focus adjustments
  const f = state.profile.focus;
  if(f==="speaking"){ w.speaking += 14; w.reading -= 6; w.writing -= 6; w.listening -= 2; }
  if(f==="writing"){ w.writing += 14; w.speaking -= 6; w.listening -= 4; w.reading -= 4; }
  if(f==="reading"){ w.reading += 14; w.writing -= 6; w.speaking -= 4; w.listening -= 4; }
  if(f==="listening"){ w.listening += 14; w.reading -= 6; w.writing -= 4; w.speaking -= 4; }

  // Multi-goals: add speaking if travel/job; add writing if exam/study
  const gs = state.profile.goals;
  if(gs.includes("travel")){ w.speaking += 6; w.listening += 2; w.writing -= 4; w.reading -= 4; }
  if(gs.includes("job")){ w.speaking += 4; w.writing += 2; w.reading -= 3; w.listening -= 3; }
  if(gs.includes("exam")){ w.reading += 4; w.writing += 4; w.speaking -= 4; w.listening -= 4; }
  if(gs.includes("study")){ w.reading += 4; w.writing += 4; w.speaking -= 4; w.listening -= 4; }

  // normalize & minimums
  const keys = Object.keys(w);
  keys.forEach(k => w[k] = Math.max(10, w[k]));
  const sum = keys.reduce((a,k)=>a+w[k],0);
  keys.forEach(k => w[k] = Math.round(w[k]/sum*100));
  // fix rounding
  const fix = 100 - (w.reading + w.listening + w.writing + w.speaking);
  w.speaking += fix;

  state.plan.weights = w;
}

function dailySplit(minutes){
  const w = state.plan.weights;
  const r = Math.round(minutes * w.reading / 100);
  const l = Math.round(minutes * w.listening / 100);
  const wri = Math.round(minutes * w.writing / 100);
  let sp = minutes - (r+l+wri);
  // enforce minimum 3
  const mins = {reading:r, listening:l, writing:wri, speaking:sp};
  const keys = ["reading","listening","writing","speaking"];
  // ensure all >=3 by borrowing from max
  for(const k of keys){
    if(mins[k] < 3){
      let need = 3 - mins[k];
      mins[k] = 3;
      while(need > 0){
        const donor = keys.slice().sort((a,b)=>mins[b]-mins[a])[0];
        if(donor===k || mins[donor] <= 3){ break; }
        mins[donor] -= 1;
        need -= 1;
      }
    }
  }
  // fix sum exactly
  let s = keys.reduce((a,k)=>a+mins[k],0);
  while(s < minutes){ mins.speaking += 1; s++; }
  while(s > minutes && mins.speaking > 3){ mins.speaking -= 1; s--; }
  return mins;
}

/* -------------------------
   Placement test (academic style, original)
-------------------------- */
const placementQuestions = [
  {hint:"Use of English", q:"Choose the best option:", options:[
    {t:"The study suggests that sleep ___ memory consolidation.", ok:true, a:"enhances"},
    {t:"The study suggests that sleep ___ memory consolidation.", ok:false, a:"enhance"},
    {t:"The study suggests that sleep ___ memory consolidation.", ok:false, a:"enhancing"}
  ]},
  {hint:"Academic vocabulary", q:"Closest meaning of 'robust' in academic writing:", options:[
    {t:"Weak", ok:false},{t:"Reliable and strong", ok:true},{t:"Temporary", ok:false}
  ]},
  {hint:"Grammar", q:"Choose the correct sentence:", options:[
    {t:"The data were collected from three sources.", ok:true},
    {t:"The data was collected from three sources.", ok:false},
    {t:"The data are collecting from three sources.", ok:false}
  ]},
  {hint:"Cohesion", q:"Choose the best linker:", stem:"The sample size was small; ___ , the findings are preliminary.", options:[
    {t:"therefore", ok:false},
    {t:"however", ok:true},
    {t:"because", ok:false}
  ]},
  {hint:"Reading inference", q:"Best interpretation:", stem:"'The policy had unintended consequences.'", options:[
    {t:"The results were exactly as planned.", ok:false},
    {t:"The results included effects not anticipated.", ok:true},
    {t:"The policy was never implemented.", ok:false}
  ]},
  {hint:"Use of English", q:"Choose the best option:", options:[
    {t:"Researchers aim to ___ bias by using randomization.", ok:true, a:"minimize"},
    {t:"Researchers aim to ___ bias by using randomization.", ok:false, a:"maximize"},
    {t:"Researchers aim to ___ bias by using randomization.", ok:false, a:"maintain"}
  ]},
  {hint:"Tense", q:"Choose the best option:", options:[
    {t:"By 2020, the team had completed the first phase.", ok:true},
    {t:"By 2020, the team has completed the first phase.", ok:false},
    {t:"By 2020, the team completes the first phase.", ok:false}
  ]},
  {hint:"Collocation", q:"Choose the best collocation:", stem:"The results are ___ with previous research.", options:[
    {t:"consistent", ok:true},
    {t:"consistency", ok:false},
    {t:"consist", ok:false}
  ]},
  {hint:"Sentence structure", q:"Choose the best option:", options:[
    {t:"Although the method is costly, it yields accurate results.", ok:true},
    {t:"Although the method is costly, but it yields accurate results.", ok:false},
    {t:"Although the method costly, it yields accurate results.", ok:false}
  ]},
  {hint:"Academic phrasing", q:"Choose the strongest academic sentence:", options:[
    {t:"I think online learning is good.", ok:false},
    {t:"Online learning can be effective because it increases access to resources.", ok:true},
    {t:"Online learning good because flexible.", ok:false}
  ]},
  {hint:"Conditionals", q:"Choose the best option:", options:[
    {t:"If the trend continues, the demand will increase.", ok:true},
    {t:"If the trend will continue, the demand will increase.", ok:false},
    {t:"If the trend continued, the demand will increase.", ok:false}
  ]},
  {hint:"C1 nuance", q:"Closest meaning of 'mitigate':", options:[
    {t:"Worsen", ok:false},
    {t:"Reduce the severity", ok:true},
    {t:"Ignore", ok:false}
  ]}
];

function renderPlacement(){
  const idx = state.placement.index;
  const q = placementQuestions[idx];
  $("qTitle").textContent = q.q;
  $("qCount").textContent = `${idx+1}/12`;
  $("qHint").textContent = q.hint;

  const sel = state.placement.answers[idx];

  $("qOptions").innerHTML = q.options.map((o,i)=>{
    const line = o.a ? `<div class="en">${q.options[i].a}</div>` : `<div class="en">${o.t}</div>`;
    const stem = q.stem ? `<div class="en muted" style="font-size:12px">${q.stem}</div>` : "";
    const picked = sel===i ? " (selected)" : "";
    return `
      <div class="option" data-i="${i}">
        ${stem}
        <div class="en">${o.a ? o.a : o.t}</div>
        <div class="muted" style="margin-top:6px; font-size:12px">${picked}</div>
      </div>
    `;
  }).join("");

  [...$("qOptions").querySelectorAll(".option")].forEach(el=>{
    el.onclick = ()=>{
      const i = +el.dataset.i;
      state.placement.answers[idx] = i;
      save();
      renderPlacement();
    };
  });

  $("qPrev").disabled = idx===0;
  $("qNext").textContent = idx===11 ? "إنهاء" : "التالي";
}

function finalizePlacement(){
  let score = 0;
  for(let i=0;i<12;i++){
    const a = state.placement.answers[i];
    if(a===null) continue;
    if(placementQuestions[i].options[a].ok) score++;
  }
  state.placement.score = score;
  const lvl = levelFromScore(score);
  state.profile.level = lvl;
  state.profile.levelConf = 0.55;
  if(lvl==="C1"){ state.profile.levelConf = 0.60; }
  // initial fluency index baseline by level
  const baseFlu = {A1:25, A2:32, B1:42, B2:55, C1:68, C2:85};
  state.profile.fluencyIndex = baseFlu[lvl] ?? 30;

  // schedule next test (weekly by default)
  const t = todayKey();
  state.plan.lastTestISO = null;
  state.plan.nextTestISO = addDaysISO(t, 7);

  calcPlanWeights();
  const pace = calcPaceFactor();
  state.plan.estimatedWeeksToNext = estimateWeeksToNext(lvl, state.profile.minutes, pace);

  save();
}

/* -------------------------
   Onboarding UI
-------------------------- */
function setObStep(step){
  state.onboarding.step = step;
  $("ob_stepLabel").textContent = `${step}/4`;

  const dots = [$("ob_dot1"), $("ob_dot2"), $("ob_dot3"), $("ob_dot4")];
  dots.forEach((d,i)=> d.style.width = (i < step ? "100%" : "12%"));

  ["ob_s1","ob_s2","ob_s3","ob_s4"].forEach((id, idx)=>{
    const el = $(id);
    el.classList.remove("active");
    el.style.display = "none";
    if(idx === step-1){
      el.style.display = "block";
      el.classList.add("active");
    }
  });

  save();
}

function renderGoals(){
  const box = $("goalsBox");
  box.innerHTML = GOALS.map(g=>{
    const active = state.profile.goals.includes(g.id);
    return `
      <button class="goalChip ${active ? "active":""}" data-goal="${g.id}" type="button">
        <span>${g.label}</span>
      </button>
    `;
  }).join("");

  [...box.querySelectorAll(".goalChip")].forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.goal;
      const set = new Set(state.profile.goals);
      if(set.has(id)) set.delete(id);
      else set.add(id);
      state.profile.goals = [...set];
      ensureGoalsValid();
      renderGoals();
      renderPrimaryGoalSelect();
      calcPlanWeights();
      save();
    };
  });
}

function renderPrimaryGoalSelect(){
  const sel = $("inpPrimaryGoal");
  ensureGoalsValid();
  sel.innerHTML = state.profile.goals.map(gid=>{
    const label = GOALS.find(x=>x.id===gid)?.label || gid;
    return `<option value="${gid}">${label}</option>`;
  }).join("");
  sel.value = state.profile.primaryGoal;
}

function buildOnboardingPlanPreview(){
  const mins = state.profile.minutes;
  const lvl = state.profile.level || "—";
  const next = lvl && lvl!=="—" ? nextLevel(lvl) : "—";
  const pace = calcPaceFactor();
  const weeks = (lvl && lvl!=="—") ? estimateWeeksToNext(lvl, mins, pace) : "—";
  const split = dailySplit(mins);
  const goals = state.profile.goals.map(gid=> GOALS.find(x=>x.id===gid)?.label || gid).join("، ");

  $("planBadge").textContent = `${mins} دقيقة/يوم`;
  $("kpiLevel").textContent = lvl;
  $("kpiFluency").textContent = String(state.profile.fluencyIndex);

  $("planBox").innerHTML = `
    <div class="muted">
      الأهداف: <b>${goals}</b><br>
      المرحلة التالية: <b class="en">${next}</b><br>
      تقدير الوصول للمرحلة التالية: <b>${weeks}</b> أسبوع (يتغير مع النتائج والالتزام).
    </div>
    <div class="hr"></div>
    <table>
      <thead><tr><th>اليوم</th><th>التوزيع</th></tr></thead>
      <tbody>
        <tr><td>Reading</td><td class="en">${split.reading} min</td></tr>
        <tr><td>Listening</td><td class="en">${split.listening} min</td></tr>
        <tr><td>Writing</td><td class="en">${split.writing} min</td></tr>
        <tr><td>Speaking</td><td class="en">${split.speaking} min</td></tr>
      </tbody>
    </table>
  `;
}

/* -------------------------
   Theme
-------------------------- */
function setTheme(t){
  state.theme = t;
  document.documentElement.setAttribute("data-theme", t);
  // set icon
  const use = (t==="dark") ? "#i-sun" : "#i-moon";
  $("#btnTheme use")?.setAttribute("href", use);
  $("#btnThemeTop use")?.setAttribute("href", use);
  $("#btnThemeSettings use")?.setAttribute("href", use);
  $("themeBadge").textContent = t;
  save();
}
function toggleTheme(){
  setTheme(state.theme==="dark" ? "light" : "dark");
}

/* -------------------------
   Persistence + import/export
-------------------------- */
function migrate(s){
  if(!s || typeof s !== "object") return null;
  if(!("version" in s)) s.version = 1;
  // add missing keys safely
  s.theme ??= "light";
  s.onboarding ??= {step:1, done:false};
  s.profile ??= {name:"", minutes:30, focus:"balanced", goals:["academic"], primaryGoal:"academic", level:null, levelConf:0.55, fluencyIndex:30};
  s.placement ??= {index:0, answers:Array(12).fill(null), score:0};
  s.progress ??= {points:0, streak:0, lastDay:null, todayPercent:0, todayStep:0, studyDoneToday:false};
  s.plan ??= {nextTestISO:null, lastTestISO:null, estimatedWeeksToNext:null, weights:{reading:25,listening:25,writing:25,speaking:25}};
  s.assessments ??= {history:[]};
  s.speaking ??= {attempts:[]};
  s.notes ??= {text:""};
  s.backups ??= {lastImportBackup:null};

  // sanitize types
  if(!Array.isArray(s.profile.goals)) s.profile.goals = ["academic"];
  ensureGoalsValid.call({}); // no-op, but we ensure after load in load()

  return s;
}

function load(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw) return;
  const parsed = safeJSONParse(raw);
  const m = migrate(parsed);
  if(!m) return;
  Object.assign(state, m);
  ensureGoalsValid();
}

function save(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}

/* -------------------------
   Streak + today progress
-------------------------- */
function ensureDay(){
  const t = todayKey();
  if(!state.progress.lastDay){
    state.progress.lastDay = t;
    state.progress.streak = 1;
    state.progress.todayPercent = 0;
    state.progress.todayStep = 0;
    state.progress.studyDoneToday = false;
    save();
    return;
  }
  if(state.progress.lastDay === t) return;

  const last = new Date(state.progress.lastDay);
  const cur = new Date(t);
  const diff = Math.round((cur-last)/(24*60*60*1000));
  if(diff === 1) state.progress.streak += 1;
  else state.progress.streak = 1;

  state.progress.lastDay = t;
  state.progress.todayPercent = 0;
  state.progress.todayStep = 0;
  state.progress.studyDoneToday = false;
  save();
}

function setTodayPercent(p){
  state.progress.todayPercent = clamp(Math.round(p), 0, 100);
  $("todayPct").textContent = state.progress.todayPercent + "%";
  $("todayBar").style.width = state.progress.todayPercent + "%";
  $("chipToday").textContent = state.progress.todayPercent + "%";
  $("studyTodayPct").textContent = state.progress.todayPercent + "%";
  $("studyTodayBar").style.width = state.progress.todayPercent + "%";
  save();
}

/* -------------------------
   Pace factor (dynamic estimate)
-------------------------- */
function calcPaceFactor(){
  // 0.7..1.3 (higher is faster)
  const mins = state.profile.minutes;
  const streak = state.progress.streak || 1;
  const testHist = state.assessments.history;
  const recent = testHist.slice(-2);
  let trend = 1.0;
  if(recent.length === 2){
    const delta = (recent[1].total - recent[0].total);
    trend += clamp(delta/100, -0.12, 0.12);
  }
  const m = mins >= 60 ? 1.2 : mins >= 45 ? 1.1 : mins >= 30 ? 1.0 : mins >= 25 ? 0.92 : 0.85;
  const s = clamp(0.9 + Math.min(streak,10)*0.02, 0.9, 1.1);
  return clamp(m*s*trend, 0.7, 1.3);
}

/* -------------------------
   Router + nav
-------------------------- */
const ROUTES = ["home","roadmap","assessments","speaking","study","progress","settings","onboarding"];

function routeTo(r){
  if(!ROUTES.includes(r)) r = "home";
  if(!state.onboarding.done && r !== "onboarding") r = "onboarding";
  location.hash = "#" + r;
}

function setActiveNav(r){
  // side nav
  [...document.querySelectorAll(".navBtn")].forEach(b=> b.classList.toggle("active", b.dataset.route===r));
  // bottom nav
  [...document.querySelectorAll(".bBtn")].forEach(b=> b.classList.toggle("active", b.dataset.route===r));
}

function setTitle(r){
  const map = {
    onboarding: ["#i-roadmap","التهيئة"],
    home: ["#i-home","الرئيسية"],
    roadmap: ["#i-roadmap","خارطة C2"],
    assessments: ["#i-assess","الاختبارات"],
    speaking: ["#i-mic","مختبر التحدث"],
    study: ["#i-book","مواد اليوم"],
    progress: ["#i-chart","التقدم"],
    settings: ["#i-gear","الإعدادات"],
  };
  const [ico, title] = map[r] || map.home;
  $("pageTitle").innerHTML = `<svg class="ico lg"><use href="${ico}"></use></svg><span>${title}</span>`;
}

function showView(r){
  ROUTES.forEach(x=>{
    const v = $("view_"+x);
    if(v){
      v.classList.remove("active");
      v.style.display = "none";
    }
  });
  const target = $("view_"+r);
  if(target){
    target.style.display = "block";
    target.classList.add("active");
  }
  setTitle(r);
  setActiveNav(r);
}

/* -------------------------
   UI rendering (global chips/profile)
-------------------------- */
function renderChips(){
  $("chipStatus").textContent = state.onboarding.done ? "مُعد" : "غير مُعد";
  $("chipLevel").textContent = state.profile.level ? state.profile.level : "—";
  $("chipFluency").textContent = state.profile.level ? String(state.profile.fluencyIndex) : "—";
  $("chipStreak").textContent = state.progress.lastDay ? `S:${state.progress.streak}` : "—";

  const nextIso = state.plan.nextTestISO;
  $("chipNextTest").textContent = nextIso ? formatISO(nextIso) : "—";

  const goals = state.profile.goals.map(gid=>GOALS.find(x=>x.id===gid)?.label||gid).join("، ");
  const lvl = state.profile.level ? state.profile.level : "—";
  const nm = state.profile.name ? state.profile.name : "—";
  $("pillMeta").textContent = `${nm} • ${lvl} • ${state.profile.minutes}m`;
  $("profileBadge").textContent = `${lvl} • ${state.profile.minutes}m`;
}

function renderProfileBoxes(){
  const nm = state.profile.name ? `<b>${state.profile.name}</b>` : `<b>مستخدم</b>`;
  const lvl = state.profile.level ? `<b class="en">${state.profile.level}</b>` : `<b>—</b>`;
  const goals = state.profile.goals.map(gid=>GOALS.find(x=>x.id===gid)?.label||gid).join("، ");
  const w = state.plan.weights;
  $("profileBox").innerHTML = `
    ${nm}<br>
    المستوى: ${lvl}<br>
    مؤشر الطلاقة: <b class="en">${state.profile.fluencyIndex}</b><br>
    الأهداف: <b>${goals}</b><br>
    نقاط: <b class="en">${state.progress.points}</b>
  `;

  $("profBadge2").textContent = state.profile.level ? state.profile.level : "—";
  $("profBox2").innerHTML = `
    ${nm}<br>
    وقت يومي: <b class="en">${state.profile.minutes} min</b><br>
    Focus: <b class="en">${state.profile.focus}</b><br>
    توزيع: <b class="en">R ${w.reading}% • L ${w.listening}% • W ${w.writing}% • S ${w.speaking}%</b>
  `;
}

/* -------------------------
   Roadmap rendering
-------------------------- */
function stageCard(level){
  const cur = state.profile.level || "A1";
  const nxt = nextLevel(cur);
  const pace = calcPaceFactor();
  const estWeeks = (cur==="C2") ? 0 : estimateWeeksToNext(cur, state.profile.minutes, pace);

  const milestones = {
    A1: ["أساسيات الجملة", "مصطلحات أكاديمية بسيطة", "Shadowing يومي"],
    A2: ["فقرات قصيرة", "روابط نصية", "ملخص 60 كلمة"],
    B1: ["استنتاجات من النص", "كتابة رأي منظم", "مناقشة قصيرة"],
    B2: ["حجج مضادة", "قراءة أطول", "تلخيص + تحليل"],
    C1: ["دقة لغوية أعلى", "كتابة أكاديمية متماسكة", "مناقشة معمقة"],
    C2: ["إتقان أسلوبي", "مرونة لغوية", "أداء قريب من الناطقين"]
  };

  const isCurrent = (level===cur);
  const isNext = (level===nxt);
  const status = isCurrent ? "Current" : isNext ? "Next" : (roadmapStageOrder().indexOf(level) < roadmapStageOrder().indexOf(cur) ? "Done" : "Locked");
  const badge = status==="Current" ? "Now" : status==="Next" ? "Next" : status==="Done" ? "Done" : "—";

  let note = "";
  if(isCurrent && cur!=="C2"){
    note = `تقدير الوصول إلى <span class="en">${nxt}</span>: <b>${estWeeks}</b> أسبوع.`;
  } else if(isCurrent && cur==="C2"){
    note = `أهداف الطلاقة والدقة تُدار باختبارات دورية للحفاظ على المستوى.`;
  }

  const items = (milestones[level]||[]).map(x=>`<li>${x}</li>`).join("");
  return `
    <div class="card" style="box-shadow:none; margin-top:12px; background:var(--panel2);">
      <div class="cardHeader" style="margin-bottom:6px">
        <div class="h1" style="font-size:15px">
          <span class="en">${level}</span>
        </div>
        <span class="badge en">${badge}</span>
      </div>
      <div class="muted">${note}</div>
      <ul class="muted" style="margin:10px 0 0; padding:0 18px;">
        ${items}
      </ul>
      ${isCurrent ? `
        <div class="row" style="margin-top:12px;">
          <button class="btn" onclick="routeTo('assessments')">بدء اختبار</button>
          <button class="btn secondary" onclick="routeTo('study')">مواد اليوم</button>
        </div>
      ` : ``}
    </div>
  `;
}

function renderRoadmap(){
  const cur = state.profile.level || "—";
  const nxt = cur!=="—" ? nextLevel(cur) : "—";
  $("roadBadge").textContent = cur!=="—" ? `Now: ${cur} → ${nxt}` : "—";
  $("roadmapBox").innerHTML = roadmapStageOrder().map(stageCard).join("");
}

/* -------------------------
   Today flow (academic)
-------------------------- */
function academicTextForToday(){
  const seed = todayKey() + "|" + (state.profile.level||"A1");
  const r = rngSeeded(seed);
  const topics = [
    "The role of feedback in learning",
    "Why scientific replication matters",
    "Technology and attention",
    "Public health and prevention",
    "Renewable energy trade-offs",
    "Urban planning and mobility"
  ];
  const topic = pick(topics, r);
  const p1 = `In academic contexts, ${topic.toLowerCase()} is often discussed in terms of evidence, limitations, and practical implications.`;
  const p2 = `A useful approach is to state a clear claim, support it with a reason, and then add a brief example or consequence.`;
  return { topic, text: `${p1} ${p2}` };
}

function renderTodayFlow(){
  const lvl = state.profile.level || "A1";
  const mins = state.profile.minutes;
  const split = dailySplit(mins);
  const {topic, text} = academicTextForToday();

  $("todayMeta").textContent = `${lvl} • ${mins}m`;
  $("capNote").textContent = `Reading ${split.reading} • Listening ${split.listening} • Writing ${split.writing} • Speaking ${split.speaking}`;

  const steps = [
    {
      title:"Warm-up Shadowing",
      body: `
        <div class="muted">اقرأ وكرر جملة أكاديمية قصيرة.</div>
        <div class="hr"></div>
        <div class="en" style="font-weight:900; font-size:16px;">Today I will practice academic English with a clear structure.</div>
        <div class="row" style="margin-top:10px;">
          <button class="btn secondary" onclick="speak('Today I will practice academic English with a clear structure.')">
            <svg class="ico"><use href="#i-volume"></use></svg><span>استماع</span>
          </button>
        </div>
      `
    },
    {
      title:`Reading (${split.reading} min)`,
      body: `
        <div class="muted">اقرأ فقرة قصيرة، ثم أجب سؤال فهم.</div>
        <div class="hr"></div>
        <div class="en" id="todayReadText" style="line-height:1.75">${text}</div>
        <div class="hr"></div>
        <div class="muted">سؤال: ما هي الفكرة الرئيسية؟</div>
        <textarea id="todayReadAns" class="en" placeholder="Type 1–2 sentences..."></textarea>
        <div class="row" style="margin-top:10px;">
          <button class="btn secondary" onclick="speak(document.getElementById('todayReadText').textContent)">
            <svg class="ico"><use href="#i-volume"></use></svg><span>استماع للنص</span>
          </button>
          <button class="btn" id="btnReadDone">تم</button>
        </div>
      `
    },
    {
      title:`Use of English (${Math.max(4, Math.round(split.writing/2))} min)`,
      body: `
        <div class="muted">اختر أفضل رابط للجملة.</div>
        <div class="hr"></div>
        <div class="en" style="font-weight:900">The sample was limited; ___ , the conclusion should be interpreted cautiously.</div>
        <div id="uoeOptions"></div>
        <div class="note" id="uoeMsg"></div>
      `
    },
    {
      title:`Listening (${split.listening} min)`,
      body: `
        <div class="muted">استمع لملخص أكاديمي قصير ثم أعد صياغته.</div>
        <div class="hr"></div>
        <div class="en" id="listenText">${text}</div>
        <div class="row" style="margin-top:10px;">
          <button class="btn secondary" onclick="speak(document.getElementById('listenText').textContent)">
            <svg class="ico"><use href="#i-volume"></use></svg><span>استماع</span>
          </button>
          <button class="btn" id="btnListenDone">تم</button>
        </div>
      `
    },
    {
      title:`Speaking (${split.speaking} min)`,
      body: `
        <div class="muted">سجّل 60 ثانية: Claim + Reason + Example.</div>
        <div class="hr"></div>
        <div class="en" id="todaySpkPrompt">Discuss: ${topic}. Provide one claim, one reason, and one example.</div>
        <div class="row" style="margin-top:10px;">
          <button class="btn secondary" onclick="routeTo('speaking')">فتح مختبر التحدث</button>
          <button class="btn" id="btnSpeakDone">تم</button>
        </div>
      `
    }
  ];

  const s = clamp(state.progress.todayStep, 0, steps.length-1);
  const step = steps[s];

  $("todayFlow").innerHTML = `
    <div class="card" style="box-shadow:none; background:var(--panel2);">
      <div class="cardHeader" style="margin-bottom:6px;">
        <div class="h1" style="font-size:15px">
          <svg class="ico"><use href="#i-check"></use></svg>
          <span>${step.title}</span>
        </div>
        <span class="badge en">${s+1}/${steps.length}</span>
      </div>
      <div>${step.body}</div>
    </div>
  `;

  // bind per-step
  if(s===1){
    const btn = $("btnReadDone");
    if(btn){
      btn.onclick = ()=>{
        const txt = ($("todayReadAns").value || "").trim();
        if(!txt){
          showToast("اكتب جملة قصيرة");
          return;
        }
        state.progress.points += 6;
        setTodayPercent(state.progress.todayPercent + 18);
        showToast("تم حفظ قراءة اليوم");
        save();
      };
    }
  }
  if(s===2){
    const opts = [
      {t:"however", ok:true},
      {t:"therefore", ok:false},
      {t:"because", ok:false}
    ];
    const box = $("uoeOptions");
    if(box){
      box.innerHTML = opts.map((o,i)=>`
        <div class="option" data-i="${i}">
          <div class="en">${o.t}</div>
        </div>
      `).join("");
      [...box.querySelectorAll(".option")].forEach(el=>{
        el.onclick = ()=>{
          const i = +el.dataset.i;
          const ok = opts[i].ok;
          [...box.querySelectorAll(".option")].forEach((x,j)=>{
            x.classList.remove("correct","wrong");
            if(j===i) x.classList.add(ok ? "correct" : "wrong");
          });
          $("uoeMsg").innerHTML = ok
            ? `<span style="color:var(--good); font-weight:900;">Correct</span>`
            : `<span style="color:var(--bad); font-weight:900;">Try again</span>`;
          if(ok){
            state.progress.points += 4;
            setTodayPercent(state.progress.todayPercent + 14);
            save();
          }
        };
      });
    }
  }
  if(s===3){
    const btn = $("btnListenDone");
    if(btn){
      btn.onclick = ()=>{
        state.progress.points += 4;
        setTodayPercent(state.progress.todayPercent + 14);
        showToast("تم حفظ استماع اليوم");
        save();
      };
    }
  }
  if(s===4){
    const btn = $("btnSpeakDone");
    if(btn){
      btn.onclick = ()=>{
        state.progress.points += 3;
        setTodayPercent(state.progress.todayPercent + 10);
        showToast("تم حفظ خطوة التحدث");
        save();
      };
    }
  }

  // step nav buttons
  $("todayBack").disabled = (s===0);
  $("todayBack").style.opacity = (s===0 ? 0.6 : 1);
  $("todayNext").textContent = (s===steps.length-1 ? "إنهاء" : "التالي");
}

$("todayBack").onclick = ()=>{
  state.progress.todayStep = clamp(state.progress.todayStep-1, 0, 4);
  save();
  renderTodayFlow();
};
$("todayNext").onclick = ()=>{
  const max = 4;
  if(state.progress.todayStep < max){
    state.progress.todayStep += 1;
    save();
    renderTodayFlow();
  }else{
    state.progress.points += 10;
    setTodayPercent(Math.max(100, state.progress.todayPercent));
    showToast("تم إنهاء جلسة اليوم");
    routeTo("progress");
  }
};

/* -------------------------
   Study page (academic block)
-------------------------- */
function studyPack(){
  const seed = todayKey() + "|study|" + (state.profile.level||"A1") + "|" + state.profile.primaryGoal;
  const r = rngSeeded(seed);

  const topics = [
    {t:"cognitive load", k:["cognitive load","working memory","instructional design"]},
    {t:"research ethics", k:["informed consent","confidentiality","risk"]},
    {t:"climate adaptation", k:["resilience","infrastructure","risk assessment"]},
    {t:"data privacy", k:["encryption","consent","data minimization"]},
    {t:"public policy evaluation", k:["baseline","outcome","trade-off"]},
  ];
  const picked = pick(topics, r);

  const passage = `In academic discussions of ${picked.t}, researchers often emphasize the importance of clear definitions and measurable outcomes. A common challenge is separating correlation from causation, especially when multiple variables interact. To strengthen an argument, writers typically outline limitations, propose alternative explanations, and suggest practical implications.`;

  const q1 = "What is the main purpose of the passage?";
  const opts = [
    {t:"To describe how to strengthen an academic argument", ok:true},
    {t:"To report a specific experiment with detailed results", ok:false},
    {t:"To argue that causation is always easy to prove", ok:false}
  ];

  const uoe = {
    stem: "Complete the sentence with the best option:",
    sent: "The findings should be interpreted cautiously, ___ the sample is not representative.",
    options: [
      {t:"since", ok:true},
      {t:"although", ok:false},
      {t:"however", ok:false}
    ]
  };

  const writing = `Write 90–130 words: Summarize the passage and add one implication for students or researchers.`;

  return { topic: picked.t, keywords: picked.k, passage, q1, opts, uoe, writing };
}

let lastStudyPack = null;

function renderStudy(){
  const lvl = state.profile.level || "A1";
  const pack = studyPack();
  lastStudyPack = pack;

  $("studyMeta").textContent = `${lvl} • ${state.profile.minutes}m`;
  $("planFocusBadge").textContent = state.profile.focus;
  const w = state.plan.weights;
  $("planFocusBox").innerHTML = `
    توزيع: <b class="en">R ${w.reading}% • L ${w.listening}% • W ${w.writing}% • S ${w.speaking}%</b><br>
    كلمات مفتاحية اليوم: <b class="en">${pack.keywords.join(", ")}</b>
  `;

  $("studyBox").innerHTML = `
    <div class="badge"><span class="en">${pack.topic}</span></div>
    <div class="hr"></div>

    <div class="en" id="studyPassage" style="line-height:1.8">${pack.passage}</div>

    <div class="hr"></div>

    <div class="muted">${pack.q1}</div>
    <div id="studyOpts">
      ${pack.opts.map((o,i)=>`
        <div class="option" data-i="${i}">
          <div class="en">${o.t}</div>
        </div>
      `).join("")}
    </div>
    <div class="note" id="studyMsg"></div>

    <div class="hr"></div>

    <div class="muted">${pack.uoe.stem}</div>
    <div class="en" style="font-weight:900">${pack.uoe.sent}</div>
    <div id="studyUOE">
      ${pack.uoe.options.map((o,i)=>`
        <div class="option" data-i="${i}">
          <div class="en">${o.t}</div>
        </div>
      `).join("")}
    </div>
    <div class="note" id="studyUoeMsg"></div>

    <div class="hr"></div>

    <div class="muted">Writing</div>
    <div class="en">${pack.writing}</div>
    <textarea id="studyWrite" class="en" placeholder="Write here..."></textarea>
  `;

  // bind options
  [...$("studyOpts").querySelectorAll(".option")].forEach(el=>{
    el.onclick = ()=>{
      const i = +el.dataset.i;
      const ok = pack.opts[i].ok;
      [...$("studyOpts").querySelectorAll(".option")].forEach((x,j)=>{
        x.classList.remove("correct","wrong");
        if(j===i) x.classList.add(ok ? "correct":"wrong");
      });
      $("studyMsg").innerHTML = ok
        ? `<span style="color:var(--good); font-weight:900;">Correct</span>`
        : `<span style="color:var(--bad); font-weight:900;">Try again</span>`;
      if(ok){
        state.progress.points += 4;
        setTodayPercent(state.progress.todayPercent + 10);
        save();
      }
    };
  });

  [...$("studyUOE").querySelectorAll(".option")].forEach(el=>{
    el.onclick = ()=>{
      const i = +el.dataset.i;
      const ok = pack.uoe.options[i].ok;
      [...$("studyUOE").querySelectorAll(".option")].forEach((x,j)=>{
        x.classList.remove("correct","wrong");
        if(j===i) x.classList.add(ok ? "correct":"wrong");
      });
      $("studyUoeMsg").innerHTML = ok
        ? `<span style="color:var(--good); font-weight:900;">Correct</span>`
        : `<span style="color:var(--bad); font-weight:900;">Try again</span>`;
      if(ok){
        state.progress.points += 4;
        setTodayPercent(state.progress.todayPercent + 10);
        save();
      }
    };
  });

  $("btnTTSStudy").onclick = ()=>{
    const t = $("studyPassage").textContent;
    if(!speak(t)) showToast("ميزة الاستماع غير متاحة");
  };

  $("markStudyDone").onclick = ()=>{
    const wtxt = ($("studyWrite").value || "").trim();
    if(wtxt.length < 40){
      showToast("اكتب نصًا أقصره 40 حرفًا");
      return;
    }
    state.progress.studyDoneToday = true;
    state.progress.points += 8;
    setTodayPercent(state.progress.todayPercent + 18);
    showToast("تم حفظ مواد اليوم");
    save();
  };

  $("goPracticeAssess").onclick = ()=> routeTo("assessments");
  $("goSpeakingFromStudy").onclick = ()=> routeTo("speaking");
}

/* -------------------------
   Assessments (periodic) - original items, academic task types
-------------------------- */
function dueType(){
  // weekly, biweekly, monthly by cadence; always show something due if past date
  const nextISO = state.plan.nextTestISO;
  if(!nextISO) return "weekly";
  const now = new Date(todayKey());
  const due = new Date(nextISO);
  if(due <= now) return "weekly";
  return "weekly";
}

function scheduleNextAfter(type){
  const t = todayKey();
  const add = type==="weekly" ? 7 : type==="biweekly" ? 14 : 28;
  state.plan.lastTestISO = t;
  state.plan.nextTestISO = addDaysISO(t, add);
}

function makeTest(type){
  const lvl = state.profile.level || "A1";
  const seed = todayKey() + "|test|" + type + "|" + lvl;
  const r = rngSeeded(seed);

  const passages = [
    "A growing body of research suggests that spaced repetition improves long-term retention by optimizing review intervals.",
    "In policy analysis, trade-offs are inevitable: allocating resources to one domain can reduce capacity in another.",
    "Meta-analyses can strengthen conclusions by combining results, but they may also inherit biases from included studies."
  ];
  const passage = pick(passages, r);

  // task-types inspired: inference, headings, cohesion, cloze
  const items = [];

  items.push({
    kind:"mcq",
    skill:"R",
    prompt:`Read and answer: ${passage}`,
    q:"Which statement best captures the main idea?",
    options:[
      {t:"The text highlights a general claim and a caution about interpretation.", ok:true},
      {t:"The text provides a detailed historical narrative.", ok:false},
      {t:"The text argues that research is unnecessary.", ok:false}
    ]
  });

  items.push({
    kind:"mcq",
    skill:"UOE",
    prompt:"Choose the best linker:",
    q:"The sample size was limited; ___ , generalization should be cautious.",
    options:[
      {t:"however", ok:true},
      {t:"therefore", ok:false},
      {t:"because", ok:false}
    ]
  });

  items.push({
    kind:"fill",
    skill:"UOE",
    prompt:"Complete with one word:",
    q:"The researchers aimed to _____ bias by using random assignment.",
    answer:"minimize",
    tip:"Academic verb meaning reduce."
  });

  items.push({
    kind:"mcq",
    skill:"L",
    prompt:"Listening (use TTS):",
    q:"What is one recommended practice in academic writing?",
    options:[
      {t:"State limitations and implications clearly.", ok:true},
      {t:"Avoid defining key terms.", ok:false},
      {t:"Use informal phrases to sound friendly.", ok:false}
    ],
    tts:`In academic writing, it is important to define key terms, acknowledge limitations, and explain implications.`
  });

  // writing task varies by type
  const writingPrompt =
    type==="weekly"
      ? "Write 60–90 words: Summarize the passage in 2–3 sentences."
      : type==="biweekly"
        ? "Write 100–140 words: Summarize the passage and add one implication for practice or research."
        : "Write 160–220 words: Present an argument related to the passage with one counterargument and a brief conclusion.";

  items.push({
    kind:"writing",
    skill:"W",
    prompt:"Writing",
    q: writingPrompt,
    minChars: type==="weekly" ? 120 : type==="biweekly" ? 180 : 300
  });

  // speaking prompt for biweekly/monthly
  if(type!=="weekly"){
    items.push({
      kind:"speaking",
      skill:"S",
      prompt:"Speaking",
      q:"Record 60 seconds: State a claim related to the passage, provide one reason, and one example."
    });
  }

  return { type, items, idx:0, answers:[] };
}

let activeTest = null;

function renderTestRunner(){
  const box = $("testRunner");
  if(!activeTest){
    box.style.display = "none";
    box.innerHTML = "";
    return;
  }
  box.style.display = "block";

  const item = activeTest.items[activeTest.idx];
  const total = activeTest.items.length;

  const header = `
    <div class="card" style="box-shadow:none; background:var(--panel2); margin-top:12px;">
      <div class="cardHeader" style="margin-bottom:6px;">
        <div class="h1" style="font-size:15px">
          <svg class="ico"><use href="#i-assess"></use></svg>
          <span class="en">${activeTest.type.toUpperCase()}</span>
        </div>
        <span class="badge en">${activeTest.idx+1}/${total}</span>
      </div>
      <div class="muted">${item.prompt}</div>
      <div class="hr"></div>
  `;

  let body = `<div class="muted">${item.q}</div>`;

  if(item.kind==="mcq"){
    body += `<div id="tOpts">` + item.options.map((o,i)=>`
      <div class="option" data-i="${i}">
        <div class="en">${o.t}</div>
      </div>
    `).join("") + `</div><div class="note" id="tMsg"></div>`;
    if(item.tts){
      body += `<div class="row" style="margin-top:10px;">
        <button class="btn secondary" id="tTTS">
          <svg class="ico"><use href="#i-volume"></use></svg><span>استماع</span>
        </button>
      </div>`;
    }
  }

  if(item.kind==="fill"){
    body += `
      <div class="row" style="margin-top:10px;">
        <input id="tFill" class="en" placeholder="Type one word..." />
        <button class="btn" id="tCheck">تحقق</button>
      </div>
      <div class="note" id="tMsg"></div>
      <div class="note">Tip: ${item.tip}</div>
    `;
  }

  if(item.kind==="writing"){
    body += `
      <textarea id="tWrite" class="en" placeholder="Write here..."></textarea>
      <div class="note">Minimum: <span class="en">${item.minChars}</span> chars</div>
    `;
  }

  if(item.kind==="speaking"){
    body += `
      <div class="note">استخدم مختبر التحدث لتسجيل المحاولة، ثم ارجع واضغط "تم".</div>
      <div class="row" style="margin-top:10px;">
        <button class="btn secondary" id="tGoSpeak">فتح مختبر التحدث</button>
      </div>
    `;
  }

  const footer = `
      <div class="hr"></div>
      <div class="row">
        <button class="btn secondary" id="tPrev">السابق</button>
        <button class="btn" id="tNext">${activeTest.idx===total-1 ? "إنهاء" : "التالي"}</button>
      </div>
    </div>
  `;

  box.innerHTML = header + body + footer;

  // binds
  $("tPrev").disabled = activeTest.idx===0;
  $("tPrev").style.opacity = activeTest.idx===0 ? 0.6 : 1;

  $("tPrev").onclick = ()=>{
    activeTest.idx = clamp(activeTest.idx-1, 0, total-1);
    renderTestRunner();
  };

  $("tNext").onclick = ()=>{
    // validate current item
    const ok = validateAndStoreCurrentTestAnswer();
    if(!ok) return;

    if(activeTest.idx < total-1){
      activeTest.idx += 1;
      renderTestRunner();
    }else{
      finalizeTest();
      activeTest = null;
      renderAssessments();
      renderChips();
      renderProfileBoxes();
      renderProgress();
      showToast("تم حفظ نتيجة الاختبار");
    }
  };

  if(item.kind==="mcq"){
    const chosen = activeTest.answers[activeTest.idx]?.pick;
    const optEls = [...$("tOpts").querySelectorAll(".option")];
    optEls.forEach((el)=>{
      const i = +el.dataset.i;
      if(chosen===i){
        el.classList.add(item.options[i].ok ? "correct":"wrong");
      }
      el.onclick = ()=>{
        activeTest.answers[activeTest.idx] = {kind:"mcq", pick:i};
        optEls.forEach(x=>x.classList.remove("correct","wrong"));
        el.classList.add(item.options[i].ok ? "correct":"wrong");
      };
    });

    if(item.tts && $("tTTS")){
      $("tTTS").onclick = ()=>{
        if(!speak(item.tts)) showToast("ميزة الاستماع غير متاحة");
      };
    }
  }

  if(item.kind==="fill"){
    const prev = activeTest.answers[activeTest.idx]?.user || "";
    $("tFill").value = prev;
    $("tCheck").onclick = ()=>{
      const user = ($("tFill").value || "").trim().toLowerCase();
      const ans = item.answer.toLowerCase();
      const ok = user === ans;
      activeTest.answers[activeTest.idx] = {kind:"fill", user, ok};
      $("tMsg").innerHTML = ok
        ? `<span style="color:var(--good); font-weight:900;">Correct</span>`
        : `<span style="color:var(--bad); font-weight:900;">Answer: <span class="en">${item.answer}</span></span>`;
    };
  }

  if(item.kind==="writing"){
    const prev = activeTest.answers[activeTest.idx]?.text || "";
    $("tWrite").value = prev;
  }

  if(item.kind==="speaking"){
    $("tGoSpeak").onclick = ()=> routeTo("speaking");
  }
}

function validateAndStoreCurrentTestAnswer(){
  const item = activeTest.items[activeTest.idx];
  const a = activeTest.answers[activeTest.idx];

  if(item.kind==="mcq"){
    if(!a || typeof a.pick !== "number"){
      showToast("اختر إجابة");
      return false;
    }
    return true;
  }
  if(item.kind==="fill"){
    const user = ($("tFill")?.value || "").trim().toLowerCase();
    if(!user){
      showToast("اكتب كلمة");
      return false;
    }
    const ans = item.answer.toLowerCase();
    activeTest.answers[activeTest.idx] = {kind:"fill", user, ok: user===ans};
    return true;
  }
  if(item.kind==="writing"){
    const text = ($("tWrite")?.value || "").trim();
    if(text.length < item.minChars){
      showToast("النص قصير");
      return false;
    }
    activeTest.answers[activeTest.idx] = {kind:"writing", text};
    return true;
  }
  if(item.kind==="speaking"){
    // require at least one speaking attempt today for validation
    const t = todayKey();
    const has = state.speaking.attempts.some(x=>x.iso===t);
    if(!has){
      showToast("سجّل محاولة تحدث لليوم");
      return false;
    }
    activeTest.answers[activeTest.idx] = {kind:"speaking", done:true};
    return true;
  }
  return true;
}

function scoreTest(test){
  // compute skill scores out of 100
  let R=0,L=0,W=0,S=0;
  let Rn=0,Ln=0,Wn=0,Sn=0;

  test.items.forEach((it, idx)=>{
    const a = test.answers[idx];
    if(it.kind==="mcq"){
      const ok = it.options[a.pick].ok;
      const pts = ok ? 1 : 0;
      if(it.skill==="R"){ R+=pts; Rn+=1; }
      if(it.skill==="L"){ L+=pts; Ln+=1; }
      if(it.skill==="UOE"){ R+=pts*0.5; W+=pts*0.5; Rn+=0.5; Wn+=0.5; }
    }
    if(it.kind==="fill"){
      const ok = a && a.ok;
      const pts = ok ? 1 : 0;
      R += pts*0.5; W += pts*0.5; Rn+=0.5; Wn+=0.5;
    }
    if(it.kind==="writing"){
      // heuristic: length-based proxy + encourages regular practice
      const len = (a?.text || "").length;
      const pts = clamp(len / it.minChars, 0.6, 1.0); // 0.6..1
      W += pts; Wn += 1;
    }
    if(it.kind==="speaking"){
      // use latest speaking rubric today as proxy
      const t = todayKey();
      const last = state.speaking.attempts.filter(x=>x.iso===t).slice(-1)[0];
      const rub = last?.rubric;
      const avg = rub ? (rub.flu + rub.coh + rub.pro + rub.lex)/20 : 0.6; // 0..1
      S += clamp(avg, 0.5, 1.0); Sn += 1;
    }
  });

  function to100(x,n){ if(n<=0) return 0; return Math.round((x/n)*100); }
  const skillScores = {
    R: to100(R,Rn),
    L: to100(L,Ln),
    W: to100(W,Wn),
    S: to100(S,Sn)
  };
  const total = Math.round((skillScores.R + skillScores.L + skillScores.W + skillScores.S) / 4);
  return {skillScores, total};
}

function levelEstimateFromTotal(total){
  // map 0..100 => A1..C2-ish
  if(total < 35) return "A1";
  if(total < 45) return "A2";
  if(total < 58) return "B1";
  if(total < 72) return "B2";
  if(total < 86) return "C1";
  return "C2";
}

function finalizeTest(){
  const t = todayKey();
  const {skillScores, total} = scoreTest(activeTest);

  const prevFlu = state.profile.fluencyIndex;
  // update level estimate with confidence (blend)
  const est = levelEstimateFromTotal(total);
  // confidence update
  state.profile.levelConf = clamp(state.profile.levelConf + 0.05, 0.55, 0.85);

  // allow level move if strong evidence
  const current = state.profile.level || est;
  const order = roadmapStageOrder();
  const ci = order.indexOf(current);
  const ei = order.indexOf(est);

  if(ei > ci && total >= 78){ state.profile.level = est; }
  if(ei < ci && total <= 40 && state.profile.levelConf < 0.75){ state.profile.level = est; }

  // fluency adjusts mildly with speaking and total
  const fluDelta = Math.round((total-60)/20); // -? .. +?
  state.profile.fluencyIndex = clamp(prevFlu + fluDelta, 0, 100);

  // points + today progress
  state.progress.points += 12;
  setTodayPercent(state.progress.todayPercent + 20);

  // schedule next
  scheduleNextAfter(activeTest.type);

  // weights adjust: emphasize weakest skill
  const minSkill = Object.entries(skillScores).sort((a,b)=>a[1]-b[1])[0][0]; // "R"/"L"/"W"/"S"
  adjustWeightsToWeakest(minSkill);

  // update estimate
  const pace = calcPaceFactor();
  state.plan.estimatedWeeksToNext = estimateWeeksToNext(state.profile.level, state.profile.minutes, pace);

  // history
  state.assessments.history.push({
    iso: t,
    type: activeTest.type,
    skillScores,
    total,
    levelEstimate: est,
    fluDelta
  });

  state.plan.lastTestISO = t;

  save();
}

function adjustWeightsToWeakest(skill){
  const w = {...state.plan.weights};
  // move 6% toward weakest, remove evenly from others
  const map = {R:"reading", L:"listening", W:"writing", S:"speaking"};
  const target = map[skill] || "reading";
  w[target] += 6;
  const others = Object.keys(w).filter(k=>k!==target);
  others.forEach(k=> w[k] -= 2);
  // normalize + minimum
  Object.keys(w).forEach(k=> w[k] = Math.max(10, w[k]));
  const sum = Object.values(w).reduce((a,b)=>a+b,0);
  Object.keys(w).forEach(k=> w[k] = Math.round(w[k]/sum*100));
  const fix = 100 - (w.reading+w.listening+w.writing+w.speaking);
  w.speaking += fix;
  state.plan.weights = w;
}

/* -------------------------
   Assessments UI
-------------------------- */
function renderAssessments(){
  const lvl = state.profile.level || "—";
  const due = state.plan.nextTestISO ? formatISO(state.plan.nextTestISO) : "—";
  $("assessMeta").textContent = `${lvl} • Next: ${due}`;

  const hist = state.assessments.history;
  const last = hist.slice(-1)[0];

  $("lastTestBadge").textContent = last ? formatISO(last.iso) : "—";
  $("lastTestSub").textContent = last ? `Total ${last.total} • Level ${last.levelEstimate}` : "—";

  $("dueTestBadge").textContent = state.plan.nextTestISO ? formatISO(state.plan.nextTestISO) : "—";
  $("dueTestSub").textContent = state.plan.nextTestISO ? "استخدم Weekly أو Biweekly حسب وقتك." : "—";

  // history list
  $("histCount").textContent = String(hist.length);
  if(hist.length===0){
    $("historyBox").innerHTML = `<div class="muted">لا يوجد سجل.</div>`;
  }else{
    $("historyBox").innerHTML = hist.slice().reverse().slice(0,8).map(x=>`
      <div class="card" style="box-shadow:none; background:var(--panel2); margin-top:10px;">
        <div class="cardHeader" style="margin-bottom:6px;">
          <div class="h1" style="font-size:14px"><span class="en">${x.type.toUpperCase()}</span></div>
          <span class="badge en">${formatISO(x.iso)}</span>
        </div>
        <div class="muted">
          Total: <b class="en">${x.total}</b><br>
          Skills: <b class="en">R ${x.skillScores.R} • L ${x.skillScores.L} • W ${x.skillScores.W} • S ${x.skillScores.S}</b><br>
          Level: <b class="en">${x.levelEstimate}</b>
        </div>
      </div>
    `).join("");
  }

  renderTestRunner();
}

/* -------------------------
   Speaking lab (recording)
-------------------------- */
let rec = {
  mediaRecorder: null,
  chunks: [],
  timer: null,
  startedAt: null,
  durationSec: 60,
  mode: "onboarding", // onboarding/lab
  lastAudioDataUrl: null
};

function caps(){
  return {
    tts: ("speechSynthesis" in window),
    media: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
    mediaRecorder: ("MediaRecorder" in window)
  };
}

function renderCaps(){
  const c = caps();
  $("capsBadge").textContent = (c.tts && c.media && c.mediaRecorder) ? "OK" : "Partial";
  $("capsBox").innerHTML = `
    <table>
      <thead><tr><th>Feature</th><th>Status</th></tr></thead>
      <tbody>
        <tr><td class="en">Text-to-Speech</td><td>${c.tts ? "Available" : "Not available"}</td></tr>
        <tr><td class="en">getUserMedia</td><td>${c.media ? "Available" : "Not available"}</td></tr>
        <tr><td class="en">MediaRecorder</td><td>${c.mediaRecorder ? "Available" : "Not available"}</td></tr>
      </tbody>
    </table>
  `;
}

function startRecorder(durationSec, onTick, onStop){
  if(!caps().media || !caps().mediaRecorder){
    showToast("التسجيل غير مدعوم على هذا الجهاز");
    return;
  }
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    rec.chunks = [];
    const mr = new MediaRecorder(stream);
    rec.mediaRecorder = mr;
    rec.startedAt = Date.now();
    rec.durationSec = durationSec;

    mr.ondataavailable = (e)=> { if(e.data && e.data.size>0) rec.chunks.push(e.data); };
    mr.onstop = async ()=>{
      stream.getTracks().forEach(t=>t.stop());
      const blob = new Blob(rec.chunks, {type:"audio/webm"});
      const dataUrl = await blobToDataURL(blob);
      rec.lastAudioDataUrl = dataUrl;
      onStop && onStop(dataUrl);
    };

    mr.start();
    let elapsed = 0;
    onTick && onTick(0);
    rec.timer = setInterval(()=>{
      elapsed = Math.floor((Date.now()-rec.startedAt)/1000);
      onTick && onTick(elapsed);
      if(elapsed >= durationSec){
        stopRecorder();
      }
    }, 250);

  }).catch(()=>{
    showToast("لا يمكن الوصول للمايكروفون");
  });
}

function stopRecorder(){
  if(rec.timer){ clearInterval(rec.timer); rec.timer = null; }
  if(rec.mediaRecorder && rec.mediaRecorder.state !== "inactive"){
    rec.mediaRecorder.stop();
  }
}

function blobToDataURL(blob){
  return new Promise((resolve)=>{
    const reader = new FileReader();
    reader.onload = ()=> resolve(reader.result);
    reader.readAsDataURL(blob);
  });
}

function mmss(sec){
  const m = String(Math.floor(sec/60)).padStart(2,"0");
  const s = String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}

function speakingTopics(){
  const lvl = state.profile.level || "A1";
  const base = [
    "How feedback improves learning outcomes",
    "Whether technology helps or harms attention",
    "A policy you would change on campus",
    "The value of group work in education",
    "How to reduce misinformation online",
    "Balancing economic growth and sustainability"
  ];
  // higher level: more abstract prompts
  const adv = [
    "To what extent standardized testing is a valid measure of ability",
    "How bias can influence research interpretation and reporting",
    "The ethical trade-offs of data collection in modern societies",
    "Whether universities should prioritize employability over scholarship"
  ];
  return (["B2","C1","C2"].includes(lvl)) ? base.concat(adv) : base;
}

function renderSpeakingLab(){
  const t = todayKey();
  $("spkMeta").textContent = `${state.profile.level || "—"} • FI ${state.profile.fluencyIndex}`;
  $("fluencyBadge").textContent = String(state.profile.fluencyIndex);
  $("fluBadge2").textContent = String(state.profile.fluencyIndex);

  // populate topics
  const topics = speakingTopics();
  $("labTopic").innerHTML = topics.map(x=>`<option value="${x}">${x}</option>`).join("");

  // "today task"
  const seed = t + "|spk|" + (state.profile.level||"A1");
  const r = rngSeeded(seed);
  const topic = pick(topics, r);
  $("todaySpeakingTask").innerHTML = `
    <div class="muted">Timed Talk</div>
    <div class="en" style="font-weight:900; margin-top:6px;">${topic}</div>
    <div class="note">Structure: claim, reason, example, short conclusion.</div>
  `;
  $("todSpkDur").textContent = "60";

  // summary
  const last = state.speaking.attempts.slice(-1)[0];
  const count = state.speaking.attempts.length;
  $("attemptCount").textContent = String(count);

  $("speakingSummary").innerHTML = last ? `
    <div>آخر محاولة: <b class="en">${formatISO(last.iso)}</b></div>
    <div class="muted">Topic: <span class="en">${last.topic}</span></div>
    <div class="muted">Rubric: <span class="en">F ${last.rubric.flu} • C ${last.rubric.coh} • P ${last.rubric.pro} • L ${last.rubric.lex}</span></div>
  ` : `<div class="muted">لا يوجد محاولات.</div>`;

  // attempts list
  $("attemptsBox").innerHTML = (count===0) ? `<div class="muted">—</div>` : state.speaking.attempts.slice().reverse().slice(0,6).map(a=>`
    <div class="card" style="box-shadow:none; background:var(--panel2); margin-top:10px;">
      <div class="cardHeader" style="margin-bottom:6px;">
        <div class="h1" style="font-size:14px"><span class="en">${formatISO(a.iso)}</span></div>
        <span class="badge en">${a.dur}s</span>
      </div>
      <div class="muted"><span class="en">${a.topic}</span></div>
      ${a.audioDataUrl ? `<audio controls style="width:100%; margin-top:10px" src="${a.audioDataUrl}"></audio>` : ``}
    </div>
  `).join("");

  // refresh topic
  $("refreshTopic").onclick = ()=> renderSpeakingLab();
  $("goStudyFromSpeaking").onclick = ()=> routeTo("study");
}

function computeFluencyDeltaFromRubric(r){
  // rubric 1..5 => avg 0..100 scale
  const avg = (r.flu + r.coh + r.pro + r.lex) / 4; // 1..5
  const target = Math.round((avg-3) * 4); // -8..+8
  return clamp(target, -6, 8);
}

/* Speaking: onboarding prompt */
function onboardingSpeakingPrompt(){
  const lvl = state.profile.level || "A1";
  const prompts = {
    A1: "Describe your study routine. Use simple sentences.",
    A2: "Explain one benefit of studying regularly. Give one example.",
    B1: "Discuss a challenge in learning and one solution.",
    B2: "Argue for or against online learning with one counterpoint.",
    C1: "Evaluate a policy in education and propose an improvement.",
    C2: "Discuss how evidence should shape decision-making in society."
  };
  return prompts[lvl] || prompts.A2;
}

/* Onboarding recorder handlers */
function setupOnboardingRecording(){
  const prompt = onboardingSpeakingPrompt();
  $("spkPrompt").textContent = prompt;
  $("btnTTS").onclick = ()=>{
    if(!speak(prompt)) showToast("ميزة الاستماع غير متاحة");
  };

  $("btnRecStart").onclick = ()=>{
    $("recNote").textContent = "";
    $("recAudio").style.display = "none";
    $("btnRecStart").disabled = true;
    $("btnRecStop").disabled = false;

    startRecorder(60, (sec)=>{
      $("spkTimer").textContent = mmss(sec);
    }, (dataUrl)=>{
      $("btnRecStart").disabled = false;
      $("btnRecStop").disabled = true;
      $("spkTimer").textContent = "00:00";
      $("recAudio").src = dataUrl;
      $("recAudio").style.display = "block";
      $("recNote").textContent = "تم حفظ التسجيل داخل المتصفح.";
      save();
    });
  };

  $("btnRecStop").onclick = ()=>{
    stopRecorder();
    $("btnRecStop").disabled = true;
  };
}

/* Speaking lab recorder handlers */
function setupLabRecording(){
  $("labTTS").onclick = ()=>{
    const topic = $("labTopic").value;
    const dur = +$("labDur").value;
    const msg = `Timed talk for ${dur} seconds. Topic: ${topic}. Use claim, reason, example, and a brief conclusion.`;
    if(!speak(msg)) showToast("ميزة الاستماع غير متاحة");
  };

  $("labStart").onclick = ()=>{
    $("labNote").textContent = "";
    $("labAudio").style.display = "none";
    $("labStart").disabled = true;
    $("labStop").disabled = false;

    const dur = +$("labDur").value;
    startRecorder(dur, (sec)=>{
      $("labTimer").textContent = mmss(sec);
    }, (dataUrl)=>{
      $("labStart").disabled = false;
      $("labStop").disabled = true;
      $("labTimer").textContent = "00:00";
      $("labAudio").src = dataUrl;
      $("labAudio").style.display = "block";
      $("labNote").textContent = "جاهز للحفظ.";
    });
  };

  $("labStop").onclick = ()=>{
    stopRecorder();
    $("labStop").disabled = true;
  };

  $("saveSpeakingAttempt").onclick = ()=>{
    if(!rec.lastAudioDataUrl){
      showToast("سجّل أولاً");
      return;
    }
    const t = todayKey();
    const dur = +$("labDur").value;
    const topic = $("labTopic").value;

    const rubric = {
      flu: +$("rFlu").value,
      coh: +$("rCoh").value,
      pro: +$("rPro").value,
      lex: +$("rLex").value
    };
    const delta = computeFluencyDeltaFromRubric(rubric);

    state.speaking.attempts.push({
      iso: t,
      topic,
      dur,
      rubric,
      audioDataUrl: rec.lastAudioDataUrl,
      fluDelta: delta
    });

    // update fluency index
    state.profile.fluencyIndex = clamp(state.profile.fluencyIndex + delta, 0, 100);

    // reward & today progress
    state.progress.points += 8;
    setTodayPercent(state.progress.todayPercent + 14);

    // update estimate
    const pace = calcPaceFactor();
    if(state.profile.level){
      state.plan.estimatedWeeksToNext = estimateWeeksToNext(state.profile.level, state.profile.minutes, pace);
    }

    rec.lastAudioDataUrl = null;
    save();
    showToast("تم حفظ المحاولة");
    renderSpeakingLab();
    renderChips();
    renderProfileBoxes();
  };
}

/* -------------------------
   Progress page
-------------------------- */
function renderProgress(){
  const lvl = state.profile.level || "—";
  $("progMeta").textContent = `${lvl} • ${state.profile.minutes}m`;

  $("streakBadge").textContent = String(state.progress.streak);
  $("streakSub").textContent = state.progress.lastDay ? `آخر يوم: ${formatISO(state.progress.lastDay)}` : "—";

  $("fluSub2").textContent = `محاولات التحدث: ${state.speaking.attempts.length}`;

  const hist = state.assessments.history.slice().reverse().slice(0,6);
  $("recentResBadge").textContent = String(state.assessments.history.length);
  $("recentResults").innerHTML = hist.length===0 ? `<div class="muted">—</div>` : `
    <table>
      <thead><tr><th>التاريخ</th><th>النوع</th><th>Total</th><th>Level</th></tr></thead>
      <tbody>
        ${hist.map(x=>`
          <tr>
            <td class="en">${formatISO(x.iso)}</td>
            <td class="en">${x.type.toUpperCase()}</td>
            <td class="en">${x.total}</td>
            <td class="en">${x.levelEstimate}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;

  $("notesArea").value = state.notes.text || "";

  const next = state.profile.level ? nextLevel(state.profile.level) : "—";
  const est = state.plan.estimatedWeeksToNext;
  const due = state.plan.nextTestISO ? formatISO(state.plan.nextTestISO) : "—";
  $("estimateExplain").innerHTML = `
    المرحلة التالية: <b class="en">${next}</b><br>
    تقدير الأسابيع: <b>${est ?? "—"}</b><br>
    الاختبار القادم: <b class="en">${due}</b><br>
    يعتمد على: وقتك اليومي، الالتزام، ونتائج الاختبارات.
  `;

  $("saveNotes").onclick = ()=>{
    state.notes.text = $("notesArea").value || "";
    save();
    showToast("تم حفظ الملاحظات");
  };

  $("goRoadmap").onclick = ()=> routeTo("roadmap");
  $("goAssess2").onclick = ()=> routeTo("assessments");
}

/* -------------------------
   Home page + next test
-------------------------- */
function renderNextTest(){
  const due = state.plan.nextTestISO;
  $("nextTestBadge").textContent = due ? formatISO(due) : "—";
  $("nextTestBox").textContent = due ? "ابدأ الاختبار من صفحة الاختبارات." : "—";
  $("chipNextTest").textContent = due ? formatISO(due) : "—";
}

$("goAssess").onclick = ()=> routeTo("assessments");
$("goSpeaking").onclick = ()=> routeTo("speaking");

/* -------------------------
   Settings import/export
-------------------------- */
function serializeState(){
  return JSON.stringify(state, null, 2);
}

function download(filename, text){
  const blob = new Blob([text], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function validateImported(obj){
  const m = migrate(obj);
  if(!m) return {ok:false, err:"Invalid JSON"};
  // minimal required fields
  if(!m.profile || !("minutes" in m.profile)) return {ok:false, err:"Missing profile"};
  if(!m.progress) return {ok:false, err:"Missing progress"};
  if(!m.onboarding) return {ok:false, err:"Missing onboarding"};
  return {ok:true, value:m};
}

function renderSettings(){
  $("setMeta").textContent = state.profile.level ? `${state.profile.level} • ${state.profile.minutes}m` : "—";
  renderCaps();
  $("themeBadge").textContent = state.theme;

  $("btnExportFile").onclick = ()=>{
    const name = `serag_export_${todayKey()}.json`;
    download(name, serializeState());
    $("exportNote").textContent = "تم تنزيل الملف.";
  };
  $("btnExportCopy").onclick = async ()=>{
    try{
      await navigator.clipboard.writeText(serializeState());
      $("exportNote").textContent = "تم النسخ.";
    }catch(e){
      $("exportNote").textContent = "تعذر النسخ.";
    }
  };

  $("btnImport").onclick = ()=>{
    const f = $("importFile").files?.[0];
    if(!f){
      $("importNote").textContent = "اختر ملفًا.";
      return;
    }
    const reader = new FileReader();
    reader.onload = ()=>{
      const raw = String(reader.result || "");
      const obj = safeJSONParse(raw);
      const v = validateImported(obj);
      if(!v.ok){
        $("importNote").textContent = "فشل الاستيراد: " + v.err;
        return;
      }
      // backup before import
      state.backups.lastImportBackup = serializeState();
      // apply imported
      const imported = v.value;
      Object.keys(state).forEach(k=> delete state[k]);
      Object.assign(state, imported);

      ensureGoalsValid();
      setTheme(state.theme || "light");
      save();
      $("importNote").textContent = "تم الاستيراد بنجاح.";
      showToast("تم استيراد البيانات");
      fullRender();
      routeTo("home");
    };
    reader.readAsText(f);
  };

  $("btnReset").onclick = ()=>{
    localStorage.removeItem(LS_KEY);
    location.reload();
  };

  $("btnThemeSettings").onclick = toggleTheme;
}

/* -------------------------
   Navigation events
-------------------------- */
function bindNav(){
  $("sideNav").onclick = (e)=>{
    const btn = e.target.closest(".navBtn");
    if(!btn) return;
    routeTo(btn.dataset.route);
  };
  $("bottomNav").onclick = (e)=>{
    const btn = e.target.closest(".bBtn");
    if(!btn) return;
    routeTo(btn.dataset.route);
  };
}

/* -------------------------
   Onboarding events
-------------------------- */
function bindOnboarding(){
  $("ob_to2").onclick = ()=>{
    state.profile.name = ($("inpName").value || "").trim();
    state.profile.minutes = +$("inpMinutes").value;
    state.profile.focus = $("inpFocus").value;
    calcPlanWeights();
    save();
    renderGoals();
    renderPrimaryGoalSelect();
    setObStep(2);
  };
  $("ob_back1").onclick = ()=> setObStep(1);

  $("ob_to3").onclick = ()=>{
    ensureGoalsValid();
    state.profile.primaryGoal = $("inpPrimaryGoal").value;
    calcPlanWeights();
    save();
    state.placement.index = 0;
    renderPlacement();
    setObStep(3);
  };
  $("ob_back2").onclick = ()=> setObStep(2);

  $("qPrev").onclick = ()=>{
    state.placement.index = clamp(state.placement.index-1, 0, 11);
    save();
    renderPlacement();
  };
  $("qNext").onclick = ()=>{
    const idx = state.placement.index;
    if(state.placement.answers[idx] === null){
      showToast("اختر إجابة");
      return;
    }
    if(idx < 11){
      state.placement.index += 1;
      save();
      renderPlacement();
    }else{
      finalizePlacement();
      // prepare step4
      $("levelBadge").textContent = state.profile.level || "—";
      const nm = state.profile.name ? `يا ${state.profile.name}، ` : "";
      $("resultText").innerHTML = `
        ${nm}نتيجة التقدير: <b class="en">${state.profile.level}</b> • Score: <b class="en">${state.placement.score}/12</b><br>
        مؤشر الطلاقة الابتدائي: <b class="en">${state.profile.fluencyIndex}</b><br>
        الاختبار القادم: <b class="en">${formatISO(state.plan.nextTestISO)}</b>
      `;
      buildOnboardingPlanPreview();
      setupOnboardingRecording();
      setObStep(4);
    }
  };

  $("ob_back3").onclick = ()=> setObStep(3);

  $("ob_finish").onclick = ()=>{
    state.onboarding.done = true;
    save();
    showToast("تم الإعداد");
    routeTo("home");
  };
}

/* -------------------------
   Assessments buttons
-------------------------- */
function bindAssessmentButtons(){
  $("btnWeekly").onclick = ()=>{
    activeTest = makeTest("weekly");
    renderTestRunner();
  };
  $("btnBiweekly").onclick = ()=>{
    activeTest = makeTest("biweekly");
    renderTestRunner();
  };
  $("btnMonthly").onclick = ()=>{
    activeTest = makeTest("monthly");
    renderTestRunner();
  };
}

/* -------------------------
   App render
-------------------------- */
function fullRender(){
  ensureDay();
  ensureGoalsValid();
  calcPlanWeights();

  // theme
  setTheme(state.theme || "light");

  // top theme button on mobile only
  $("btnThemeTop").style.display = (window.matchMedia("(max-width: 980px)").matches ? "inline-flex" : "none");
  $("btnThemeTop").onclick = toggleTheme;
  $("btnTheme").onclick = toggleTheme;

  // next test meta
  renderChips();
  renderProfileBoxes();
  renderNextTest();

  // today progress bars
  setTodayPercent(state.progress.todayPercent);

  // views
  const hash = (location.hash || "#home").replace("#","");
  const r = (!state.onboarding.done) ? "onboarding" : (ROUTES.includes(hash) ? hash : "home");
  showView(r);

  // page-specific renders
  if(r==="onboarding"){
    $("inpName").value = state.profile.name || "";
    $("inpMinutes").value = String(state.profile.minutes || 30);
    $("inpFocus").value = state.profile.focus || "balanced";
    renderGoals();
    renderPrimaryGoalSelect();
    $("inpPrimaryGoal").value = state.profile.primaryGoal;
    setObStep(state.onboarding.step || 1);
  }
  if(r==="home"){
    renderTodayFlow();
    renderNextTest();
  }
  if(r==="roadmap"){
    renderRoadmap();
  }
  if(r==="assessments"){
    renderAssessments();
  }
  if(r==="speaking"){
    renderSpeakingLab();
  }
  if(r==="study"){
    renderStudy();
  }
  if(r==="progress"){
    renderProgress();
  }
  if(r==="settings"){
    renderSettings();
  }

  // chips also need updates after page renders
  renderChips();
}

/* -------------------------
   Global binds
-------------------------- */
function bindGlobals(){
  // prevent accidental form submit
  document.addEventListener("submit", (e)=> e.preventDefault());

  // theme bindings are set in fullRender to match icons
  bindNav();
  bindOnboarding();
  bindAssessmentButtons();
  setupLabRecording();

  // speaking page quick buttons
  $("goStudyFromSpeaking").onclick = ()=> routeTo("study");
  $("goStudyFromSpeaking").onclick = ()=> routeTo("study");
  $("goStudyFromSpeaking").onclick = ()=> routeTo("study");
  $("goStudyFromSpeaking").onclick = ()=> routeTo("study");

  $("goStudyFromSpeaking").onclick = ()=> routeTo("study");
  $("goStudyFromSpeaking").onclick = ()=> routeTo("study");

  $("goStudyFromSpeaking").onclick = ()=> routeTo("study");

  $("goStudyFromSpeaking").onclick = ()=> routeTo("study");

  // stable binds
  $("goStudyFromSpeaking").onclick = ()=> routeTo("study");

  // from speaking side card
  $("goStudyFromSpeaking").onclick = ()=> routeTo("study");
}

window.addEventListener("hashchange", ()=> fullRender());
window.addEventListener("resize", ()=> fullRender());

/* -------------------------
   Boot
-------------------------- */
load();
bindGlobals();
fullRender();
</script>
</body>
</html>
